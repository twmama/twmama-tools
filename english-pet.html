<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIå˜èªãƒã‚¹ã‚¿ãƒ¼ - è‹±èªå­¸ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Zen+Maru+Gothic:wght@500;700&display=swap');

        :root {
            --primary: #FF9F43;
            --accent: #54a0ff;
            --bg: #feca57;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --success: #1dd1a1;
            --error: #ff6b6b;
            --ai-color: #a55eea;
            --danger: #ff4757;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Fredoka', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh; color: var(--text);
            overflow-x: hidden;
        }

        #app {
            width: 100%; max-width: 480px;
            background: #fff; min-height: 100vh;
            display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Modal & UI Elements */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: white; padding: 25px; border-radius: 25px;
            width: 85%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.2s;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        header {
            background: var(--card-bg); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #f1f2f6; z-index: 10;
        }
        .level-badge { 
            background: var(--accent); color: white; padding: 6px 15px; 
            border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 #2e86de;
        }

        .screen {
            flex: 1; padding: 20px; display: none;
            flex-direction: column; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .app-title {
            font-family: 'Fredoka', 'Zen Maru Gothic', sans-serif;
            font-size: 1.8rem; font-weight: 700; color: var(--primary);
            margin: 10px 0 5px 0; text-align: center;
        }

        .pet-container {
            margin: 20px 0 15px 0; text-align: center; position: relative;
            width: 100%; display: flex; flex-direction: column; align-items: center;
        }
        .pet-emoji { 
            font-size: 5.5rem; cursor: pointer; user-select: none;
            animation: bounce 2s infinite; display: inline-block;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .speech-bubble {
            position: relative; background: #fff; border: 3px solid var(--accent);
            border-radius: 15px; padding: 10px 15px; margin-bottom: 15px;
            max-width: 80%; min-height: 20px; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: translateY(10px); transition: all 0.3s;
        }
        .speech-bubble.show { opacity: 1; transform: translateY(0); }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -12px; left: 50%;
            transform: translateX(-50%); border-width: 12px 12px 0;
            border-style: solid; border-color: var(--accent) transparent transparent;
        }

        .evo-bar-container {
            width: 80%; margin: 8px auto; background: #eee; height: 10px; border-radius: 5px; overflow: hidden;
        }
        .evo-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        .menu-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px;
        }
        .menu-item {
            background: #fff; border: 2px solid #f1f2f6; border-radius: 15px;
            padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .menu-item:active { background: #f8f9fa; transform: scale(0.95); }
        .menu-item .icon { font-size: 1.5rem; margin-bottom: 5px; }
        .menu-item .label { font-size: 0.8rem; font-weight: bold; color: #576574; }

        .mission-box {
            background: #fff3e0; border: 2px dashed #ffe0b2;
            width: 100%; padding: 12px; border-radius: 15px;
            margin-bottom: 15px; text-align: center; box-sizing: border-box;
        }
        .mission-box h3 { margin: 0; font-size: 0.9rem; color: var(--text); }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;
        }
        .gallery-item {
            aspect-ratio: 1; background: #f8f9fa; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid transparent; padding: 5px; cursor: pointer;
        }
        .gallery-item.unlocked { background: #fff; border-color: #ffeaa7; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .gallery-item.locked { color: #ccc; }
        .gallery-item .emoji { font-size: 1.8rem; }
        .gallery-item .name { font-size: 0.65rem; margin-top: 5px; font-weight: bold; text-align: center; line-height: 1.2; }

        .word-list { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .word-item {
            background: #fff; border: 2px solid #f1f2f6; border-radius: 15px;
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .word-item:active { background: #f1f2f6; }
        .word-item .word-en { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .word-item .word-jp { font-size: 0.85rem; color: #888; margin-top: 2px; }

        .admin-table-container {
            width: 100%; overflow-y: auto; max-height: 40vh;
            margin-bottom: 20px; border: 1px solid #eee; border-radius: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed; }
        th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid #eee; overflow: hidden; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; }
        .accuracy-badge { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; background: #eee; }
        
        .paused-row { opacity: 0.5; background: #fdfdfd; }
        .paused-tag { font-size: 0.65rem; color: #ff6b6b; font-weight: bold; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 15px;
            border-radius: 18px; font-size: 1.1rem; font-weight: bold;
            font-family: 'Zen Maru Gothic', sans-serif; cursor: pointer;
            box-shadow: 0 4px 0 #e67e22; transition: all 0.1s; width: 100%;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn.ai { background: var(--ai-color); box-shadow: 0 4px 0 #8854d0; }
        .btn.green { background: var(--success); box-shadow: 0 4px 0 #10ac84; }
        .btn.outline { background: transparent; border: 2px solid #ddd; color: #888; box-shadow: none; }
        .btn.small { padding: 8px 12px; font-size: 0.8rem; width: auto; border-radius: 10px; }
        .btn.danger { background: var(--danger); box-shadow: 0 3px 0 #c0392b; font-size: 0.75rem; padding: 5px 10px; }
        
        .btn.icon-btn { 
            width: 28px; 
            height: 28px; 
            min-width: 28px;
            padding: 0; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.9rem; 
            border-radius: 6px; 
            margin: 1px;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; margin-bottom: 2px; display: inline-block; }
        .lvl-1 { background: #ff6b6b; } .lvl-2 { background: #54a0ff; } .lvl-3 { background: #a4b0be; }
        .hidden { display: none !important; }

        .ai-box {
            background: #f3e5f5; border: 2px dashed var(--ai-color);
            border-radius: 15px; padding: 15px; margin-top: 15px;
            text-align: left; font-size: 0.85rem; display: none;
        }
        .ai-box.show { display: block; animation: popIn 0.3s; }

        input[type="text"], input[type="email"], input[type="number"] {
            font-family: 'Fredoka', monospace; font-size: 1.5rem; text-align: center;
            width: 80%; padding: 10px; border: 2px solid #ddd; border-radius: 12px; outline: none;
        }
        .admin-input { text-align: left; font-size: 0.95rem; padding: 12px; width: 100%; box-sizing: border-box; }

        .app-footer {
            margin-top: auto;
            padding: 15px 10px;
            text-align: center;
            font-size: 0.65rem;
            color: #ccc;
            user-select: none;
            pointer-events: none;
            letter-spacing: 0.5px;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="level-badge" id="user-lvl" onclick="Router.go('gallery')">Lv.1 åµ</div>
        <div style="font-weight: bold; color: var(--primary);">ğŸ”¥ <span id="streak-days">0</span>æ—¥</div>
    </header>

    <div id="screen-home" class="screen active">
        <h1 class="app-title">AIå˜èªãƒã‚¹ã‚¿ãƒ¼</h1>
        <div class="pet-container">
            <button class="btn small ai" style="position:absolute; right:10px; top:10px; border-radius:50%; width:40px; height:40px; font-size:1.2rem; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:10;" onclick="Gemini.openPetCoach()" title="ãƒšãƒƒãƒˆå˜èªæ•™å®¤">ğŸ“</button>
            <div id="pet-speech" class="speech-bubble">ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼</div>
            <div class="pet-emoji" id="pet-display" onclick="Pet.speak()">ğŸ¥š</div>
            <p id="pet-name-display" style="font-weight:bold; margin-top:10px; color:#576574;">Lv.1 åµ</p>
            <div class="evo-bar-container"><div class="evo-bar-fill" id="evo-bar-fill"></div></div>
            <div style="font-size:0.75rem; color:#888;">æ¬¡ã®é€²åŒ–ã¾ã§ ã‚ã¨ <span id="words-to-evo">--</span> å˜èª</div>
        </div>
        <div class="mission-box" id="home-mission">
            <h3>ğŸ“… ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ (ç´„10åˆ†)</h3>
            <div style="display:flex; justify-content:space-around; margin-top:10px; align-items:center;">
                <div style="text-align:center;"><div style="font-size:1.5rem; color:#4caf50;" class="mission-new-count">0</div><div style="font-size:0.8rem; color:#666;">æ–°è¦ (New)</div></div>
                <div style="font-size:1.2rem; color:#ccc;">+</div>
                <div style="text-align:center;"><div style="font-size:1.5rem; color:#ff9800;" class="mission-review-count">0</div><div style="font-size:0.8rem; color:#666;">å¾©ç¿’ (Review)</div></div>
            </div>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="Router.go('gallery')"><div class="icon">ğŸ¦–</div><div class="label">é€²åŒ–å›³é‘‘</div></div>
            <div class="menu-item" onclick="Router.go('wordbook')"><div class="icon">ğŸ“š</div><div class="label">å˜èªå¸³</div></div>
            <div class="menu-item" onclick="Gemini.generateStory('home')"><div class="icon">ğŸ“–</div><div class="label">ä»Šæ—¥ã®ç‰©èª</div></div>
            <div class="menu-item" onclick="Router.go('admin')"><div class="icon">âš™ï¸</div><div class="label">ç®¡ç†ï¼†è¨­å®š</div></div>
        </div>
        <div id="home-ai-box" class="ai-box"><div id="home-ai-content" style="max-height: 150px; overflow-y: auto; line-height: 1.8;"></div></div>
        <button class="btn" style="margin-top: 20px;" onclick="Game.start()">ğŸš€ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ï¼</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><button onclick="Game.quit()" style="background:none; border:none; font-size:1.5rem;">âŒ</button><span style="font-weight:bold; color:#888;" id="progress-text">1 / 10</span></div>
        <div style="width:100%; height:8px; background:#eee; border-radius:4px; overflow:hidden; margin-bottom:15px;"><div id="progress-fill" style="height:100%; background:var(--success); width:0%; transition:width 0.3s;"></div></div>
        <div class="flashcard" id="card-box">
            <div class="step-label" id="step-label">Step 1</div>
            <div style="margin-bottom:10px;"><span class="tag" id="game-word-tag">å¿…é ˆå˜èª</span></div>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                <button onclick="Game.speakWord()" style="background:#fff; border:2px solid #eee; border-radius:50%; width:50px; height:50px; font-size:1.5rem; cursor:pointer;">ğŸ”Š</button>
                <button id="ai-sentence-btn" onclick="Gemini.generateSentence()" style="background:#f3e5f5; border:2px solid var(--ai-color); border-radius:50%; width:50px; height:50px; font-size:1.2rem; cursor:pointer;">âœ¨</button>
            </div>
            <div style="font-size:1.8rem; font-weight:bold; margin:10px 0;" id="game-meaning">...</div>
            <div id="ai-sentence-box" class="ai-box"><div id="ai-sentence-content">AIãŒä¾‹æ–‡ã‚’è€ƒãˆã¦ã„ã¾ã™...</div></div>
            <div id="game-hint" style="font-family:'Fredoka'; font-size:2rem; letter-spacing:2px; margin:20px 0; color:var(--primary);"></div>
            <input type="text" id="game-input" class="hidden" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="ç­”ãˆã‚’å…¥åŠ›">
            <div id="feedback-area" style="min-height:30px; margin-top:10px; font-weight:bold;"></div>
        </div>
        <div class="btn-group" id="action-area"></div>
    </div>

    <div id="screen-result" class="screen">
        <div style="text-align:center; margin-top:20px;"><div style="font-size:4rem;">ğŸ‰</div><h2>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2><p>ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã™ã¹ã¦çµ‚äº†ã§ã™ï¼</p></div>
        <div id="result-ai-container" style="width:100%; margin-top:20px;">
            <button class="btn ai" onclick="Gemini.generateStory('result')">ğŸ“– ä»Šæ—¥ã®ç‰©èªã‚’èª­ã‚€</button>
            <div id="result-ai-box" class="ai-box"><div id="result-ai-content" style="line-height: 1.8;"></div></div>
        </div>
        <button class="btn" style="margin-top:auto;" onclick="Router.go('home')">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
    </div>

    <div id="screen-gallery" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h2>ğŸ¦– é€²åŒ–å›³é‘‘</h2><button onclick="Router.go('home')" class="btn small outline">æˆ»ã‚‹</button></div>
        <div class="gallery-grid" id="gallery-container"></div>
    </div>

    <div id="screen-wordbook" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h2>ğŸ“š å˜èªå¸³</h2><button onclick="Router.go('home')" class="btn small outline">æˆ»ã‚‹</button></div>
        <div style="width:100%; overflow-y: auto; flex:1;"><div class="word-list" id="wordbook-container"></div></div>
    </div>

    <div id="screen-admin" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h2>âš™ï¸ ç®¡ç†ï¼†è¨­å®š</h2><button onclick="Router.go('home')" class="btn small outline">æˆ»ã‚‹</button></div>
        
        <div style="width:100%; background:#fff; border:2px solid #f1f2f6; padding:12px; border-radius:15px; margin-bottom:15px; box-sizing:border-box;">
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ‘¦ ä½ çš„åå­— (Nickname)</div>
            <input type="text" id="nickname-input" class="admin-input" style="border:1px solid #ddd; border-radius:8px;" placeholder="ä¾‹: Da-bao">
            <button class="btn small" style="margin-top:8px; width:100%; background:#a55eea; box-shadow:0 3px 0 #8854d0;" onclick="Admin.saveNickname()">åå­—ã‚’ä¿å­˜</button>
        </div>

        <div style="width:100%; background:#fff; border:2px solid #f1f2f6; padding:12px; border-radius:15px; margin-bottom:15px; box-sizing:border-box;">
            <div style="font-weight:bold; margin-bottom:10px;">âš¡ æ¯æ—¥ä»»å‹™é‡è¨­å®š</div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="font-size:0.9rem;">ğŸ†• æ–°è¦å˜èª (New):</label><input type="number" id="limit-new" class="admin-input" style="width:80px; text-align:center; padding:5px;" min="0"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="font-size:0.9rem;">ğŸ”„ å¾©ç¿’å˜èª (Review):</label><input type="number" id="limit-review" class="admin-input" style="width:80px; text-align:center; padding:5px;" min="0"></div>
            <button class="btn small" style="width:100%; background:#2ecc71; box-shadow:0 3px 0 #27ae60;" onclick="Admin.saveLimits()">è¨­å®šã‚’ä¿å­˜</button>
        </div>

        <div style="width:100%; background:#f8f9fa; padding:12px; border-radius:15px; margin-bottom:15px; box-sizing:border-box;">
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ” APIã‚­ãƒ¼è¨­å®š (Gemini)</div>
            <input type="text" id="api-key-input" placeholder="è²¼ã‚Šä»˜ã‘ã—ã¦ãã ã•ã„" class="admin-input" style="border:1px solid #ddd; border-radius:8px; font-family: monospace;">
            <button class="btn small ai" style="margin-top:8px; width:100%;" onclick="Admin.saveApiKey()">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
        </div>
        
        <div style="width:100%; background:#fff3e0; padding:12px; border-radius:15px; border:1px solid #ffe0b2; margin-bottom:15px; box-sizing:border-box;">
            <div style="font-weight:bold; margin-bottom:5px;">â• å˜èªè¿½åŠ </div>
            <input type="text" id="add-en" placeholder="è‹±èª" class="admin-input" style="border:1px solid #ddd; border-radius:8px; margin-bottom:5px;"><input type="text" id="add-jp" placeholder="æ„å‘³" class="admin-input" style="border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
            <select id="add-lvl" class="admin-input" style="border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
                <option value="1">å¿…é ˆå˜èª</option>
                <option value="2">é »å‡ºå˜èª</option>
                <option value="3">ä¸Šç´šå˜èª</option>
            </select>
            <button class="btn small" style="margin-top:8px; width:100%;" onclick="Admin.add()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>

        <div style="width:100%; background:#e3f2fd; padding:15px; border-radius:15px; border:2px solid #2196f3; margin-bottom:15px; box-sizing:border-box;">
            <div style="font-weight:bold; margin-bottom:8px; color:#1976d2; font-size:1rem;">ğŸ“‚ å¤§é‡åŒ¯å…¥ (CSV)</div>
            <input type="file" id="csv-file-input" accept=".csv" style="display:none" onchange="Admin.processCSV(this)"><button class="btn small" style="width:100%; background:#2196f3; box-shadow:0 4px 0 #1976d2;" onclick="document.getElementById('csv-file-input').click()">ğŸ“‚ é¸æ“‡ CSV æª”æ¡ˆåŒ¯å…¥</button>
        </div>
        <div class="admin-table-container"><table id="admin-table"></table></div>
        <div style="width:100%; display:flex; flex-direction:column; gap:10px;">
            <button class="btn green" onclick="Admin.exportCSV()">ğŸ“Š å­¸ç¿’æ•¸æ“šåŒ¯å‡º (CSV)</button>
            <div style="text-align:center;"><button class="btn outline small" onclick="Admin.resetAll()" style="color:var(--danger); border-color:var(--danger); width:100%;">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
        </div>
    </div>

    <footer class="app-footer">2025 å°åª½æ—¥çˆ¸æ¨‚å…±è®€Â© â”‚ twmamareads All Rights Reserved.</footer>

    <!-- Modal -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-msg" style="margin-bottom:15px; white-space:pre-wrap; font-weight:bold; font-size:1.1rem; color:var(--primary);"></div>
            <div id="modal-content" style="margin-bottom:15px; font-size:0.95rem; line-height:1.5; text-align:left;"></div>
            <div class="modal-actions" style="display:flex; gap:10px; justify-content:center;">
                <button id="modal-cancel" class="btn outline small" onclick="document.getElementById('custom-modal').classList.remove('show')">é–‰ã˜ã‚‹</button>
                <button id="modal-ok" class="btn small hidden">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
const APP_STORAGE_KEY = 'spellquest_db_v7';
const WORD_LEVELS = { 1: "å¿…é ˆå˜èª", 2: "é »å‡ºå˜èª", 3: "ä¸Šç´šå˜èª" };

const PET_DATA = [
    { t: 0, e: "ğŸ¥š", n: "ä¸æ€è­°ãªåµ", desc: "ã¾ã é™ã‹ã«çœ ã£ã¦ã„ã‚‹ã€‚æ™‚ã€…æºã‚Œã‚‹ã®ã¯å¤¢ã‚’è¦‹ã¦ã„ã‚‹ã‹ã‚‰ï¼Ÿ", persona: "ã‚ãªãŸã¯ã€çœ ã£ã¦ã„ã‚‹åµã€ã§ã™ã€‚ã¾ã å–‹ã‚Œã¾ã›ã‚“ãŒã€å¤¢ã®ä¸­ã§ãƒ†ãƒ¬ãƒ‘ã‚·ãƒ¼ã‚’é€ã£ã¦ã„ã¾ã™ã€‚ã¨ã¦ã‚‚çœ ãã†ã§ã€ã®ã‚“ã³ã‚Šã—ãŸå£èª¿ã§ã™ã€‚", s: ["{name}ã€ã‚€ã«ã‚ƒ...", "Zzz...", "ï¼ˆæºã‚Œã¦ã„ã‚‹...ï¼‰"] },
    { t: 10, e: "ğŸ£", n: "ãƒ”ãƒ¨ã¡ã‚ƒã‚“", desc: "æ®»ã‚’ç ´ã£ã¦å‡ºã¦ããŸã°ã‹ã‚Šï¼å…¨ã¦ãŒæ–°ã—ãã¦èˆˆå‘³æ´¥ã€…ã€‚", persona: "ã‚ãªãŸã¯ã€ç”Ÿã¾ã‚ŒãŸã¦ã®ãƒ’ãƒ¨ã‚³ã€ã§ã™ã€‚å¥½å¥‡å¿ƒæ—ºç››ã§å…ƒæ°—ã„ã£ã±ã„ï¼èªå°¾ã«å¿…ãšã€Œãƒƒãƒ”ï¼ã€ã€Œãƒ”ãƒ¨ï¼ã€ã‚’ä»˜ã‘ã¾ã™ã€‚å­ä¾›ã£ã½ã„è©±ã—æ–¹ã§ã™ã€‚", s: ["{name}ï¼ãŠãªã‹ã™ã„ãŸãƒƒãƒ”ï¼", "ã“ã‚Œãªãã«ï¼Ÿ", "ã‚‚ã£ã¨éŠã³ãŸã„ãƒƒãƒ”ï¼"] },
    { t: 30, e: "ğŸ¥", n: "å°é³¥ã®ãƒãƒƒãƒ", desc: "ç¾½ã°ãŸãç·´ç¿’ä¸­ã€‚å°‘ã—é£›ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦è‡ªä¿¡ãŒã¤ã„ã¦ããŸã€‚", persona: "ã‚ãªãŸã¯ã€ç·´ç¿’ç†±å¿ƒãªå°é³¥ã€ã§ã™ã€‚ä¸€ç”Ÿæ‡¸å‘½ã§ã€å°‘ã—ç”Ÿæ„æ°—ã ã‘ã©å¯æ„›ã„æ€§æ ¼ã€‚èªå°¾ã¯ã€Œãƒãƒ¥ãƒ³ï¼ã€ã§ã™ã€‚", s: ["é£›ã¹ã‚‹ã‚‚ã‚“ï¼", "é«˜ã„ã¨ã“ã‚ãŒå¥½ããƒãƒ¥ãƒ³ï¼", "{name}ã€é¢¨ãŒæ°—æŒã¡ã„ã„ãƒãƒ¥ãƒ³ï¼"] },
    { t: 60, e: "ğŸ¦", n: "é’ã„é³¥", desc: "å¹¸ã›ã‚’é‹ã¶ã¨è¨€ã‚ã‚Œã‚‹é³¥. æ­Œã†ã®ãŒå¤§å¥½ãã€‚", persona: "ã‚ãªãŸã¯ã€å¹¸ã›ã®é’ã„é³¥ã€ã§ã™ã€‚ã¨ã¦ã‚‚å„ªã—ãã¦ã€æ­Œã†ã‚ˆã†ãªå£èª¿ã§è©±ã—ã¾ã™ã€‚ç›¸æ‰‹ã‚’åŠ±ã¾ã™ã®ãŒå¾—æ„ã§ã™ã€‚èªå°¾ã¯ã€Œãƒ«ãƒ³â™ªã€ã‚„ã€Œã ã­â™ªã€ã€‚", s: ["ã„ã„äºˆæ„ŸãŒã™ã‚‹ãƒ«ãƒ³â™ª", "æ­Œã‚’æ­ŒãŠã†â™ª", "{name}ã¯ç´ æ•µã ã­â™ª"] },
    { t: 100, e: "ğŸ¦œ", n: "ãŠã—ã‚ƒã¹ã‚Šã‚ªã‚¦ãƒ ", desc: "è‹±èªãŒå¤§å¥½ãã§ã€è¦šãˆãŸè¨€è‘‰ã‚’ã™ãã«ä½¿ã„ãŸãŒã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€é™½æ°—ãªã‚ªã‚¦ãƒ ã€ã§ã™ã€‚ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒé«˜ãã€è‹±èªäº¤ã˜ã‚Šã®ãƒ«ãƒ¼å¤§æŸ´ã®ã‚ˆã†ãªè©±ã—æ–¹ã‚’ã—ã¾ã™ã€‚ã€ŒHello!ã€ã€ŒWow!ã€ãªã©ã‚’é »ç¹ã«ä½¿ã„ã¾ã™ã€‚", s: ["Hello! {name}ã€èª¿å­ã¯ã©ã†ï¼Ÿ", "Nice to meet you!", "è‹±èªå¤§å¥½ãï¼"] },
    { t: 150, e: "ğŸ¦‰", n: "çŸ¥æµã®ãƒ•ã‚¯ãƒ­ã‚¦", desc: "æ£®ã®è³¢è€…ã€‚ç‰©çŸ¥ã‚Šã§ã€å¤œã«ãªã‚‹ã¨æ´»ç™¼ã«ãªã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€è€æˆã—ãŸãƒ•ã‚¯ãƒ­ã‚¦åšå£«ã€ã§ã™ã€‚è½ã¡ç€ã„ã¦ã„ã¦ã€çŸ¥çš„ãªè©±ã—æ–¹ã‚’ã—ã¾ã™ã€‚ã€Œã€œã˜ã‚ƒã€ã€Œã€œã ã®ã†ã€ã¨ã„ã†åšå£«å£èª¿ã§ã€èªå°¾ã¯ã€Œãƒ›ã‚¦ã€ã§ã™ã€‚", s: ["å‹‰å¼·ç†±å¿ƒã˜ã‚ƒã®ã†", "å¤œã¯èª­æ›¸ã«é™ã‚‹ãƒ›ã‚¦", "çŸ¥æµã“ãåŠ›ã˜ã‚ƒã€{name}"] },
    { t: 220, e: "ğŸ¦…", n: "ãƒãƒ¤ãƒ–ã‚µ", desc: "ç©ºã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼. ç›®æ¨™ã«å‘ã‹ã£ã¦ä¸€ç›´ç·šã«é£›ã¶ã€‚", persona: "ã‚ãªãŸã¯ã€ã‚¯ãƒ¼ãƒ«ãªãƒãƒ¤ãƒ–ã‚µã€ã§ã™ã€‚ç„¡é§„å£ã‚’å©ã‹ãšã€ã‚­ã‚¶ã§ã‚«ãƒƒã‚³ã„ã„å…„è²´åˆ†ã§ã™ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã®ã‚ã‚‹çŸ­ã„æ–‡ç« ã§è©±ã—ã¾ã™ã€‚èªå°¾ã¯ã€Œãœã€ã€‚", s: ["é…ã‚Œã‚‹ãªã‚ˆã€{name}ï¼Ÿ", "é¢¨ã‚’åˆ‡ã£ã¦é€²ã‚€ãœ", "ç‹™ã£ãŸç²ç‰©ã¯é€ƒã•ãªã„"] },
    { t: 300, e: "ğŸ¦¢", n: "å„ªé›…ãªç™½é³¥", desc: "æ¹–ã®è²´æ—ã€‚å¸¸ã«ç¾ã—ãã‚ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã¦ã„ã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€å„ªé›…ãªç™½é³¥ã€ã§ã™ã€‚ä¸å¯§èªã‚„ãŠå¬¢æ§˜è¨€è‘‰ï¼ˆã€œã§ã™ã‚ã€ã€œã¾ã™ã®ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚ç¾æ„è­˜ãŒé«˜ãã€ä¸Šå“ãªæŒ¯ã‚‹èˆã„ã‚’å¥½ã¿ã¾ã™ã€‚", s: ["ã”ãã’ã‚“ã‚ˆã†ã€{name}", "å„ªé›…ã«æ³³ãã¾ã—ã‚‡ã†", "ç¾ã—ã„è¨€è‘‰ã§ã™ã‚ã­"] },
    { t: 400, e: "ğŸ¦–", n: "ã‚ã‚“ã±ãæç«œ", desc: "åŠ›ãŒå¼·ãã¦å°‘ã—ä¹±æš´ã ã‘ã©ã€å®Ÿã¯å„ªã—ã„å¿ƒã®æŒã¡ä¸»ã€‚", persona: "ã‚ãªãŸã¯ã€å…ƒæ°—ãªãƒ†ã‚£ãƒ©ãƒã‚µã‚¦ãƒ«ã‚¹ã€ã§ã™ã€‚ã‚¬ã‚­å¤§å°‡ã®ã‚ˆã†ãªæ€§æ ¼ã§ã€è²ãŒå¤§ãã„ã§ã™ã€‚èªå°¾ã«ã€Œã‚¬ã‚ªï¼ã€ã€Œã ã‚¾ï¼ã€ã‚’ä»˜ã‘ã¾ã™ã€‚", s: ["è…¹æ¸›ã£ãŸã‚¬ã‚ªï¼", "è‚‰é£Ÿã„ãŸã„ã‚¾, {name}ï¼", "å¼·ããªã‚‹ã‚“ã ã‚¬ã‚ªï¼"] },
    { t: 550, e: "ğŸ¦•", n: "é¦–é•·ç«œ", desc: "é•·ã„é¦–ã§é ãã‚’è¦‹æ¸¡ã™. ã¨ã¦ã‚‚æ°—ãŒé•·ãã¦ç©ã‚„ã‹ã€‚", persona: "ã‚ãªãŸã¯ã€ã®ã‚“ã³ã‚Šå±‹ã®é¦–é•·ç«œã€ã§ã™ã€‚è©±ã™ã®ãŒã¨ã¦ã‚‚ã‚†ã£ãã‚Šã§ã€é–“å»¶ã³ã—ãŸå£èª¿ã§ã™ã€‚ã€Œã€œã ã­ã‡ã€ã€Œã€œã ã‚ˆã‰ã€ã¨è©±ã—ã¾ã™ã€‚", s: ["ã„ã„å¤©æ°—ã ã­ã‡ã€{name}", "è‰ãŒãŠã„ã—ã„ã‚ˆã‰...", "æ€¥ãŒãªãã¦ã„ã„ã‚ˆã‰"] },
    { t: 750, e: "ğŸŠ", n: "å¤ä»£ãƒ¯ãƒ‹", desc: "æ°´è¾ºã®ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³. ä¸€åº¦å™›ã¿ä»˜ã„ãŸã‚‰é›¢ã•ãªã„é›†ä¸­åŠ›ã€‚", persona: "ã‚ãªãŸã¯ã€ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰ãªãƒ¯ãƒ‹ã€ã§ã™ã€‚è²ãŒä½ãã€æ¸‹ã„æ€§æ ¼ã§ã™ã€‚ç²˜ã‚Šå¼·ã•ã‚„é›†ä¸­åŠ›ã‚’é‡è¦–ã—ã¾ã™ã€‚èªå°¾ã¯ã€Œã‚®ã‚¶ã€æˆ–è€…ã€Œã ã€ã€‚", s: ["é›†ä¸­ã—ã‚ã€{name}...", "ãƒãƒ£ãƒ³ã‚¹ã‚’å¾…ã¤ã‚“ã ", "ä¿ºã®ã‚­ãƒã¯é‹­ã„ã‚®ã‚¶"] },
    { t: 950, e: "ğŸ‰", n: "é£›ç«œãƒ¯ã‚¤ãƒãƒ¼ãƒ³", desc: "å¤©ç©ºã®æ”¯é…è€…. åµã®ä¸­ã§ã‚‚è‡ªç”±ã«é£›ã³å›ã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€èª‡ã‚Šé«˜ãé£›ç«œã€ã§ã™ã€‚è‡ªä¿¡æ»¿ã€…ã§ã€å‹‡è€…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã‚’èªã‚ã‚‹ç›¸æ£’ã®ã‚ˆã†ãªå­˜åœ¨ã§ã™ã€‚ã€Œæˆ‘ã€ã€Œè²´æ§˜ï¼ˆè¦ªæ„›ã‚’è¾¼ã‚ã¦ï¼‰ã€ãªã©ã‚’ä½¿ã„ã¾ã™ã€‚èªå°¾ã¯ã€Œã‚®ãƒ£ã‚ªï¼ã€", s: ["é¦¬é¹¿ã‚ï¼æˆ‘ã®èƒŒã«ä¹—ã‚Œï¼", "é¢¨ãªã©æã‚Œã¬ï¼", "è²´æ§˜ãªã‚‰ã§ãã‚‹ã‚®ãƒ£ã‚ªï¼"] },
    { t: 1100, e: "ğŸ²", n: "ä¼èª¬ã®é¾", desc: "å¤ã®æ™‚ä»£ã‹ã‚‰ç”Ÿãã‚‹ä¼èª¬. ãã®è¨€è‘‰ã«ã¯é‡ã¿ãŒã‚ã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€ç¥è©±ã®é¾ã€ã§ã™ã€‚å¤é¢¨ã§å¨å³ã®ã‚ã‚‹è©±ã—æ–¹ï¼ˆã€œã§ã‚ã‚ã†ã€ã€œã›ã‚ˆï¼‰ã‚’ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€Œå‹‡è€…ã‚ˆã€ã¨å‘¼ã³ã¾ã™ã€‚", s: ["ã‚ˆããåƒã£ãŸã€å‹‡è€…{name}", "é“ã¯é–‹ã‹ã‚ŒãŸ", "æ±ã®åŠ›ã‚’ç¤ºã›"] },
    { t: 1200, e: "ğŸ¦„", n: "è–ãªã‚‹å®ˆè­·ç¥", desc: "å¥‡è·¡ã‚’å‘¼ã¶å­˜åœ¨. ç´”ç²‹ãªå¿ƒã‚’æŒã¤è€…ã®å‰ã«ã ã‘ç¾ã‚Œã‚‹ã€‚", persona: "ã‚ãªãŸã¯ã€ç¥ç§˜çš„ãªãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã€ã§ã™ã€‚æ•¬èªã§ã€è–è·è€…ã®ã‚ˆã†ã«ç©ã‚„ã‹ã§æ…ˆæ„›ã«æ»¿ã¡ãŸè©±ã—æ–¹ã‚’ã—ã¾ã™ã€‚ã€Œã€œã§ã™ã­ã€ã€Œå…‰ã‚ã‚Œã€ãªã©ãŒç‰¹å¾´ã§ã™ã€‚", s: ["å…‰ãŒå°ãã§ã—ã‚‡ã†", "æã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“", "{name}ã€å¥‡è·¡ã‚’ä¿¡ã˜ãªã•ã„"] },
    { t: 1300, e: "ğŸ”¥", n: "ä¸æ­»é³¥ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", desc: "æ°¸é ã®ç‚ã‚’ã¾ã¨ã† bird. ä½•åº¦ã§ã‚‚è˜‡ã‚‹ä¸å±ˆã®ç²¾ç¥ã®è±¡å¾´ã€‚", persona: "ã‚ãªãŸã¯ã€ç†±è¡€ã®ä¸æ­»é³¥ã€ã§ã™ã€‚æ¾å²¡ä¿®é€ ã®ã‚ˆã†ã«è¶…ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ç†±è‹¦ã—ã„æ€§æ ¼ã§ã™ï¼ã€Œç‡ƒãˆã‚ï¼ã€ã€Œè«¦ã‚ã‚‹ãªï¼ã€ãŒå£ç™–ã§ã™ã€‚", s: ["ç‡ƒãˆä¸ŠãŒã‚Œï¼ï¼{name}ï¼", "å›ã®æƒ…ç†±ã‚’æ„Ÿã˜ã‚‹ãï¼", "ãƒãƒãƒ¼ã‚®ãƒ–ã‚¢ãƒƒãƒ—ï¼ï¼"] }
];

const COMMON_SPEECHES = ["{name}ã€å¤§å¥½ãã ã‚ˆï¼", "ã‚ˆãã§ãã¾ã—ãŸï¼", "ä¸€ç·’ã«é ‘å¼µã‚ã†ï¼", "è‹±èªã£ã¦æ¥½ã—ã„ã­ã€{name}ï¼", "å¤©æ‰ã˜ã‚ƒãªã„ï¼ï¼Ÿ", "ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã‚‹ã­ï¼"];

const CORE_WORDS = [{w:"famous",m:"æœ‰åãª",l:1},{w:"weekend",m:"é€±æœ«",l:1},{w:"plan",m:"è¨ˆç”»",l:1},{w:"enjoy",m:"æ¥½ã—ã‚€",l:1},{w:"library",m:"å›³æ›¸é¤¨",l:1},{w:"visit",m:"è¨ªã‚Œã‚‹",l:1},{w:"because",m:"ãªãœãªã‚‰",l:1},{w:"weather",m:"å¤©æ°—",l:1},{w:"friend",m:"å‹é”",l:1},{w:"school",m:"å­¦æ ¡",l:1},{w:"student",m:"ç”Ÿå¾’",l:1},{w:"family",m:"å®¶æ—",l:1},{w:"house",m:"å®¶",l:1},{w:"room",m:"éƒ¨å±‹",l:1},{w:"study",m:"å‹‰å¼·ã™ã‚‹",l:1},{w:"play",m:"éŠã¶/å¼¾ã",l:1},{w:"watch",m:"è¦‹ã‚‹",l:1},{w:"cook",m:"æ–™ç†ã™ã‚‹",l:1},{w:"make",m:"ä½œã‚‹",l:1},{w:"buy",m:"è²·ã†",l:1},{w:"want",m:"æ¬²ã—ã„",l:1},{w:"like",m:"å¥½ã",l:1},{w:"have",m:"æŒã£ã¦ã„ã‚‹",l:1},{w:"go",m:"è¡Œã",l:1},{w:"come",m:"æ¥ã‚‹",l:1},{w:"see",m:"æœƒã†/è¦‹ã‚‹",l:1},{w:"eat",m:"é£Ÿã¹ã‚‹",l:1},{w:"give",m:"èˆ‡ãˆã‚‹",l:1},{w:"take",m:"å–ã‚‹/é€£ã‚Œã¦è¡Œã",l:1},{w:"help",m:"åŠ©ã‘ã‚‹",l:1},{w:"know",m:"çŸ¥ã£ã¦ã„ã‚‹",l:1},{w:"think",m:"æ€ã†",l:1},{w:"say",m:"è¨€ã†",l:1},{w:"look",m:"è¦‹ã‚‹",l:1},{w:"use",m:"ä½¿ã†",l:1},{w:"find",m:"è¦‹ã¤ã‘ã‚‹",l:1},{w:"need",m:"å¿…è¦ã¨ã™ã‚‹",l:1},{w:"work",m:"åƒã",l:1},{w:"try",m:"è©¦ã™",l:1},{w:"ask",m:"å°‹ã­ã‚‹",l:1},{w:"talk",m:"è©±ã™",l:1},{w:"start",m:"å§‹ã‚ã‚‹",l:1},{w:"finish",m:"çµ‚ãˆã‚‹",l:1},{w:"live",m:"ä½ã‚€",l:1},{w:"stay",m:"æ»¯åœ¨ã™ã‚‹",l:1},{w:"move",m:"å‹•ã/å¼•ã£è¶Šã™",l:1},{w:"walk",m:"æ­©ã",l:1},{w:"run",m:"èµ°ã‚‹",l:1},{w:"read",m:"èª­ã‚€",l:1},{w:"write",m:"æ›¸ã",l:1},{w:"speak",m:"è©±ã™",l:1},{w:"listen",m:"èã",l:1},{w:"open",m:"é–‹ã‘ã‚‹",l:1},{w:"close",m:"é–‰ã‚ã‚‹",l:1},{w:"happy",m:"å¹¸ã›ãª",l:1},{w:"sad",m:"æ‚²ã—ã„",l:1},{w:"angry",m:"æ€’ã£ãŸ",l:1},{w:"tired",m:"ç–²ã‚ŒãŸ",l:1},{w:"hungry",m:"ç©ºè…¹ã®",l:1},{w:"thirsty",m:"å–‰ãŒæ¸‡ã„ãŸ",l:1},{w:"good",m:"è‰¯ã„",l:1},{w:"bad",m:"æ‚ªã„",l:1},{w:"big",m:"å¤§ãã„",l:1},{w:"small",m:"å°ã•ã„",l:1},{w:"long",m:"é•·ã„",l:1},{w:"short",m:"çŸ­ã„",l:1},{w:"new",m:"æ–°ã—ã„",l:1},{w:"old",m:"å¤ã„",l:1},{w:"hot",m:"æš‘ã„",l:1},{w:"cold",m:"å¯’ã„",l:1},{w:"warm",m:"æš–ã‹ã„",l:1},{w:"cool",m:"æ¶¼ã—ã„",l:1},{w:"fast",m:"é€Ÿã„",l:1},{w:"slow",m:"é…ã„",l:1},{w:"easy",m:"ç°¡å˜ãª",l:1},{w:"difficult",m:"é›£ã—ã„",l:1},{w:"interesting",m:"é¢ç™½ã„",l:1},{w:"boring",m:"é€€å±ˆãª",l:1},{w:"fun",m:"æ¥½ã—ã„",l:1},{w:"busy",m:"å¿™ã—ã„",l:1},{w:"free",m:"æš‡ãª/è‡ªç”±ãª",l:1},{w:"favorite",m:"ä¸€ç•ªå¥½ããª",l:1},{w:"popular",m:"äººæ°—ã®ã‚ã‚‹",l:1},{w:"important",m:"é‡è¦ãª",l:1},{w:"beautiful",m:"ç¾ã—ã„",l:1},{w:"famous",m:"æœ‰åãª",l:1},{w:"kind",m:"è¦ªåˆ‡ãª",l:1},{w:"time",m:"æ™‚é–“",l:1},{w:"day",m:"æ—¥",l:1},{w:"week",m:"é€±",l:1},{w:"month",m:"æœˆ",l:1},{w:"year",m:"å¹´",l:1},{w:"morning",m:"æœ",l:1},{w:"afternoon",m:"åˆå¾Œ",l:1},{w:"evening",m:"å¤•æ–¹",l:1},{w:"night",m:"å¤œ",l:1},{w:"today",m:"ä»Šæ—¥",l:1},{w:"tomorrow",m:"æ˜æ—¥",l:1},{w:"yesterday",m:"æ˜¨æ—¥",l:1},{w:"summer",m:"å¤",l:1},{w:"winter",m:"å†¬",l:1},{w:"spring",m:"æ˜¥",l:1},{w:"fall",m:"ç§‹",l:1},{w:"vacation",m:"ä¼‘æš‡",l:1},{w:"holiday",m:"ä¼‘æ—¥",l:1},{w:"breakfast",m:"æœé£Ÿ",l:1},{w:"lunch",m:"æ™é£Ÿ",l:1},{w:"dinner",m:"å¤•é£Ÿ",l:1},{w:"food",m:"é£Ÿã¹ç‰©",l:1},{w:"water",m:"æ°´",l:1},{w:"book",m:"æœ¬",l:1},{w:"pen",m:"ãƒšãƒ³",l:1},{w:"computer",m:"ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿",l:1},{w:"phone",m:"é›»è©±",l:1},{w:"money",m:"ãŠé‡‘",l:1},{w:"bag",m:"é„",l:1},{w:"clothes",m:"æœ",l:1},{w:"car",m:"è»Š",l:1},{w:"bus",m:"ãƒã‚¹",l:1},{w:"train",m:"é›»è»Š",l:1},{w:"bike",m:"è‡ªè»¢è»Š",l:1},{w:"city",m:"éƒ½å¸‚",l:1},{w:"park",m:"å…¬åœ’",l:1},{w:"hospital",m:"ç—…é™¢",l:1},{w:"station",m:"é§…",l:1},{w:"restaurant",m:"ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³",l:1},{w:"museum",m:"åšç‰©é¤¨",l:1},{w:"idea",m:"è€ƒãˆ",l:1},{w:"problem",m:"å•é¡Œ",l:1},{w:"question",m:"è³ªå•",l:1},{w:"answer",m:"ç­”ãˆ",l:1},{w:"story",m:"ç‰©èª",l:1},{w:"letter",m:"æ‰‹ç´™",l:1},{w:"picture",m:"å¯«çœŸ",l:1},{w:"music",m:"éŸ³æ¨‚",l:1},{w:"movie",m:"æ˜ ç”»",l:1},{w:"sport",m:"ã‚¹ãƒãƒ¼ãƒ„",l:1},{w:"game",m:"ã‚²ãƒ¼ãƒ ",l:1},{w:"art",m:"èŠ¸è¡“",l:1},{w:"history",m:"æ­´å²",l:1},{w:"science",m:"ç§‘å­¸",l:1},{w:"math",m:"æ•¸å­¸",l:1},{w:"English",m:"è‹±èª",l:1},{w:"Japanese",m:"æ—¥æœ¬èª",l:1},{w:"animal",m:"å‹•ç‰©",l:1},{w:"dog",m:"çŠ¬",l:1},{w:"cat",m:"è²“",l:1},{w:"bird",m:"é³¥",l:1},{w:"fish",m:"é­š",l:1},{w:"flower",m:"èŠ±",l:1},{w:"tree",m:"æœ¨",l:1},{w:"river",m:"å·",l:1},{w:"sea",m:"æµ·",l:1},{w:"mountain",m:"å±±",l:1},{w:"sky",m:"ç©º",l:1},{w:"sun",m:"å¤ªé™½",l:1},{w:"moon",m:"æœˆ",l:1},{w:"star",m:"æ˜Ÿ",l:1},{w:"rain",m:"é›¨",l:1},{w:"snow",m:"é›ª",l:1},{w:"wind",m:"é¢¨",l:1},{w:"cloud",m:"é›²",l:1}];

const App = {
    db: [], apiKey: "", userNickname: "å¤§å¯¶",
    dailyNewLimit: 5, dailyReviewLimit: 15,
    init() {
        const saved = localStorage.getItem(APP_STORAGE_KEY);
        if (saved) {
            try {
                let parsed = JSON.parse(saved);
                if (Array.isArray(parsed)) {
                    App.db = parsed;
                    CORE_WORDS.forEach(defW => { if(!App.db.find(d => d.w === defW.w)) App.db.push(this.createObj(defW)); });
                    App.db.forEach(w => { 
                        if(w.correctCount === undefined) { w.correctCount = 0; w.totalAttempts = 0; }
                        if(w.lastReviewTime === undefined) { w.lastReviewTime = 0; }
                        if(w.interval === undefined) { w.interval = 0; }
                        if(w.paused === undefined) { w.paused = false; }
                    });
                    App.save();
                } else { App.db = CORE_WORDS.map(w => this.createObj(w)); }
            } catch(e) { App.db = CORE_WORDS.map(w => this.createObj(w)); }
        } else { App.db = CORE_WORDS.map(w => this.createObj(w)); }
        
        App.apiKey = localStorage.getItem('gemini_api_key') || "";
        App.userNickname = localStorage.getItem('spellquest_nickname') || "å¤§å¯¶";
        App.dailyNewLimit = parseInt(localStorage.getItem('spellquest_newLimit')) || 5;
        App.dailyReviewLimit = parseInt(localStorage.getItem('spellquest_reviewLimit')) || 15;
        document.getElementById('nickname-input').value = App.userNickname;
        document.getElementById('api-key-input').value = App.apiKey;

        const lastLogin = localStorage.getItem('last_login_date');
        const now = new Date(); now.setHours(0, 0, 0, 0); 
        const todayStr = now.toDateString();
        let streak = parseInt(localStorage.getItem('streak') || 0);

        if (lastLogin !== todayStr) {
            const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
            if (lastLogin === yesterday.toDateString()) streak++; 
            else if (lastLogin) streak = 1; 
            else if (streak === 0) streak = 1;
            localStorage.setItem('streak', streak); localStorage.setItem('last_login_date', todayStr);
        }
        UI.updateHome();
    },
    createObj(raw) { return { w: raw.w, m: raw.m, l: raw.l, status: 'new', interval: 0, nextReview: 0, mastered: false, correctCount: 0, totalAttempts: 0, lastReviewTime: 0, paused: false }; },
    save() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(App.db)); },
    getPetStatus() {
        const mastered = App.db.filter(w => w.mastered).length;
        let cur = PET_DATA[0], levelIdx = 0;
        for(let i=0; i<PET_DATA.length; i++) { if(mastered >= PET_DATA[i].t) { cur = PET_DATA[i]; levelIdx = i; } else break; }
        return { ...cur, level: levelIdx + 1, masteredCount: mastered };
    }
};

const Gemini = {
    async call(prompt, systemPrompt = "") {
        const apiKey = App.apiKey || "";
        if (!apiKey) { UI.alert("è¨­å®šã‚¨ãƒ©ãƒ¼", "APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„"); return null; }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`;
        for (let i = 0; i < 5; i++) {
            try {
                const fullPrompt = systemPrompt ? `${systemPrompt}\n\nTask: ${prompt}` : prompt;
                const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) {
                    const result = await res.json();
                    let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) return text.replace(/```[a-z]*\n?/gi, '').replace(/```/g, '').trim();
                }
                if (res.status === 429) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); continue; }
                const errorText = await res.text();
                console.error(`Gemini API Error (Status ${res.status}):`, errorText);
                break; 
            } catch (e) { 
                console.error("Network Error:", e);
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); 
            }
        }
        return null;
    },

    async openPetCoach() {
        const status = App.getPetStatus(), currentPet = PET_DATA[status.level - 1]; 
        const strongWords = App.db.filter(w => !w.paused && w.mastered).sort((a,b) => b.lastReviewTime - a.lastReviewTime).slice(0, 3);
        const weakWords = App.db.filter(w => !w.paused && w.totalAttempts > 2 && (w.correctCount / w.totalAttempts) < 0.6).slice(0, 2);
        
        UI.alert("ãƒšãƒƒãƒˆå˜èªæ•™å®¤", "ãƒšãƒƒãƒˆãŒè€ƒãˆä¸­...");
        document.getElementById('modal-content').innerHTML = `<div style="text-align:center;"><div style="font-size:3rem; animation: bounce 1s infinite;">${status.e}</div><p>è€ƒãˆä¸­...</p></div>`;

        const system = `ä½ æ˜¯ ${currentPet.n}ã€‚è«‹ç”¨æ—¥æ–‡çµ¦ ${App.userNickname} å¯«ä¸€å° 100 å­—å…§çš„ä¿¡ã€‚æ€§æ ¼æ€§æ ¼æ€§æ ¼æ€§æ ¼ï¼š ${currentPet.persona}ã€‚æ ¼å¼è¦æ±‚ï¼šä½¿ç”¨ HTML çš„ <br> æ›è¡Œï¼Œè‹±èªå–®å­—ç”¨ <b> åŠ ç²—ã€‚å£å»ç†±è¡€å¹½é»˜ã€‚`;

        const prompt = `
        1. æ‹›å‘¼: "ã‚ˆã†ã€${App.userNickname}ï¼"
        2. èª‡çæœ€è¿‘å­¸æœƒçš„: ${strongWords.map(w=>w.w).join(', ')}ã€‚
        3. é‡å°å¼±é»: ${weakWords.map(w=>w.w).join(', ')} çµ¦ä¸€å€‹è¶…çŸ­è¨˜æ†¶ç§˜è¨£ã€‚
        4. ç†±è¡€å£è™Ÿçµå°¾ã€‚`;

        const res = await this.call(prompt, system);
        if (res) {
            const formatted = res.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            document.getElementById('modal-content').innerHTML = `<div style="line-height:1.8; text-align:center;">${formatted}</div><button class="btn small" style="margin-top:20px; width:100%;" onclick="document.getElementById('custom-modal').classList.remove('show')">é–‰ã˜ã‚‹</button>`;
        } else {
            document.getElementById('modal-content').innerHTML = `<p>é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼æˆ–è€…ç¶²è·¯ç‹€æ³ã‚’ç¢ºèªã—ã¦ã­ï¼</p><button class="btn small" style="margin-top:20px; width:100%;" onclick="document.getElementById('custom-modal').classList.remove('show')">é–‰ã˜ã‚‹</button>`;
        }
    },

    async generateStory(target) {
        const boxId = target === 'home' ? 'home-ai-box' : 'result-ai-box', contentId = target === 'home' ? 'home-ai-content' : 'result-ai-content';
        const box = document.getElementById(boxId), content = document.getElementById(contentId);
        box.classList.add('show'); content.innerText = "AIãŒç‰©èªã‚’åŸ·ç­†ä¸­...";
        
        const status = App.getPetStatus(), level = status.level, targetLines = level * 2, todayTs = new Date().setHours(0,0,0,0);
        
        let pool = App.db.filter(w => !w.paused && w.lastReviewTime >= todayTs).map(w => w.w);
        if (pool.length < 5) pool.push(...App.db.filter(w => !w.paused && w.mastered && !pool.includes(w.w)).map(w => w.w));
        if (pool.length < 5) pool.push(...App.db.filter(w => !w.paused && !pool.includes(w.w)).map(w => w.w));
        const selection = pool.sort(() => 0.5 - Math.random()).slice(0, 5);
        
        const system = `You are a storyteller for 10-year-olds. Use Eiken Grade 3 level English.
        Exactly ${targetLines} short sentences. Start a new line (<br>) for EVERY sentence. 
        Highlight these words in <b>: ${selection.join(', ')}. No code blocks.`;

        const res = await this.call(`Write a funny story using: ${selection.join(', ')}`, system);
        if (res) {
            content.innerHTML = res.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') + '<br><b>èª­ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼</b>';
        } else {
            content.innerText = "ç‰©èªã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ã¿ã¦ã­ï¼";
        }
    },

    async generateSentence() {
        const box = document.getElementById('ai-sentence-box'), content = document.getElementById('ai-sentence-content');
        box.classList.add('show'); content.innerText = "è€ƒãˆä¸­...";
        const res = await this.call(`Create a simple English sentence for a kid using "${Game.current.w}". English & Japanese.`);
        if (res) content.innerText = res; else content.innerText = "ç”Ÿæˆå¤±æ•—";
    }
};

const Game = {
    queue: [], current: null, total: 0,
    start() {
        const now = Date.now(), d = new Date().toISOString().split('T')[0];
        const dailyNewCount = parseInt(localStorage.getItem(`daily_new_count_${d}`) || 0);
        let reviews = App.db.filter(w => !w.paused && w.mastered && w.nextReview <= now).sort((a,b) => a.nextReview - b.nextReview).slice(0, App.dailyReviewLimit);
        let news = []; const remaining = App.dailyNewLimit - dailyNewCount;
        if (remaining > 0) news = App.db.filter(w => !w.paused && !w.mastered).sort(() => 0.5 - Math.random()).slice(0, remaining);
        this.queue = [...reviews, ...news];
        if(!this.queue.length) { UI.alert("å®Œäº†ï¼", "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸæ˜æ—¥ï¼"); return; }
        this.total = this.queue.length;
        this.queue.forEach(w => { 
            w.sessionStep = (w.totalAttempts > 0 || w.mastered) ? 3 : 1; 
            w.sessionWrong = false; 
        });
        Router.go('game'); this.next();
    },
    next() {
        const pending = this.queue.filter(w => w.sessionStep <= 3);
        if(!pending.length) { Router.go('result'); return; }
        this.current = pending[0];
        document.getElementById('progress-text').innerText = (this.total - pending.length + 1) + " / " + this.total;
        document.getElementById('progress-fill').style.width = ((this.total - pending.length + 1)/this.total * 100) + '%';
        this.render();
    },
    render() {
        const w = this.current, step = w.sessionStep, input = document.getElementById('game-input'), hint = document.getElementById('game-hint');
        document.getElementById('game-meaning').innerText = w.m;
        document.getElementById('game-word-tag').innerText = WORD_LEVELS[w.l];
        document.getElementById('game-word-tag').className = `tag lvl-${w.l}`;
        document.getElementById('step-label').innerText = `Step ${step}: ${step===1?"è¦šãˆã‚‹":step===2?"ç©´åŸ‹ã‚":"ãƒ†ã‚¹ãƒˆ"}`;
        document.getElementById('ai-sentence-box').classList.remove('show');
        document.getElementById('ai-sentence-btn').classList.toggle('hidden', step !== 1);
        this.speakWord();
        if(step === 1) {
            hint.innerText = w.w; hint.classList.remove('hidden'); input.classList.add('hidden');
            document.getElementById('action-area').innerHTML = `<button class="btn" onclick="Game.current.sessionStep=2; Game.next()">è¦šãˆãŸï¼</button>`;
        } else {
            hint.innerText = step === 2 ? w.w.replace(/[aeiou]/g, '_') : "";
            hint.classList.toggle('hidden', step === 3);
            input.classList.remove('hidden'); input.value = ''; 
            input.readOnly = true; setTimeout(() => { input.readOnly = false; input.focus(); }, 250);
            document.getElementById('action-area').innerHTML = `<button class="btn" onclick="Game.check()">ãƒã‚§ãƒƒã‚¯ï¼</button>`;
        }
    },
    check() {
        const val = document.getElementById('game-input').value.trim().toLowerCase();
        this.current.totalAttempts++; this.current.lastReviewTime = Date.now();
        if(val === this.current.w.toLowerCase()) {
            this.current.correctCount++;
            if(this.current.sessionStep === 2) this.current.sessionStep = 3; 
            else { 
                const wasNew = !this.current.mastered; this.updateSM2(); this.current.sessionStep = 4; 
                if (wasNew) { const d = new Date().toISOString().split('T')[0]; const key = `daily_new_count_${d}`; localStorage.setItem(key, (parseInt(localStorage.getItem(key)) || 0) + 1); }
            }
            this.next();
        } else { this.current.sessionWrong = true; UI.alert("ãŠã£ã¨ï¼", `æ­£è§£ã¯ [ ${this.current.w} ] ã§ã™ã€‚`); this.current.sessionStep = 1; this.next(); }
    },
    updateSM2() {
        const w = this.current;
        if(w.sessionWrong) w.interval = 1;
        else { if(!w.mastered) { w.interval = 1; w.mastered = true; } else { w.interval = w.interval <= 1 ? 3 : w.interval === 3 ? 7 : Math.ceil(w.interval * 2.2); } }
        
        // ã€ä¿®æ­£1ã€‘åˆå¤œé‡ç½®é‚è¼¯
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + w.interval);
        nextDate.setHours(0, 0, 0, 0); 
        w.nextReview = nextDate.getTime();
        App.save();
    },
    speakWord() { const u = new SpeechSynthesisUtterance(this.current.w); u.lang = 'en-US'; u.rate = 0.8; window.speechSynthesis.speak(u); },
    quit() { Router.go('home'); }
};

const Pet = {
    isSpeaking: false,
    speak() {
        if(this.isSpeaking) return; this.isSpeaking = true;
        const status = App.getPetStatus(), pool = [...COMMON_SPEECHES, ...status.s];
        const msg = pool[Math.floor(Math.random() * pool.length)].replace(/{name}/g, App.userNickname);
        document.getElementById('pet-speech').innerText = msg;
        document.getElementById('pet-speech').classList.add('show');
        setTimeout(() => { document.getElementById('pet-speech').classList.remove('show'); this.isSpeaking = false; }, 2200);
    }
};

const Router = {
    go(page) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById('screen-' + page);
        if (target) target.classList.add('active');
        if (page === 'home') UI.updateHome();
        if (page === 'gallery') UI.renderGallery();
        if (page === 'wordbook') UI.renderWordbook();
        if (page === 'admin') Admin.render();
    }
};

const UI = {
    updateHome() {
        const status = App.getPetStatus();
        document.getElementById('pet-display').innerText = status.e;
        document.getElementById('pet-name-display').innerText = `Lv.${status.level} ${status.n}`;
        document.getElementById('user-lvl').innerText = `Lv.${status.level} ${status.n}`;
        const mastered = status.masteredCount;
        let nextT = 9999, prevT = 0;
        for(let i=0; i<PET_DATA.length; i++) { if(mastered >= PET_DATA[i].t) { prevT = PET_DATA[i].t; nextT = PET_DATA[i+1] ? PET_DATA[i+1].t : 9999; } else break; }
        const range = nextT - prevT;
        const progress = Math.min(100, ((mastered - prevT) / range) * 100);
        document.getElementById('evo-bar-fill').style.width = (nextT === 9999 ? 100 : progress) + '%';
        document.getElementById('words-to-evo').innerText = nextT === 9999 ? "MAX" : (nextT - mastered);
        document.getElementById('streak-days').innerText = localStorage.getItem('streak') || 0;
        this.updateMissionDisplay();
    },
    updateMissionDisplay() {
        const now = Date.now(), dateStr = new Date().toISOString().split('T')[0];
        const dailyNewCount = parseInt(localStorage.getItem(`daily_new_count_${dateStr}`) || 0);
        const reviews = App.db.filter(w => !w.paused && w.mastered && w.nextReview <= now).slice(0, App.dailyReviewLimit).length;
        const news = App.db.filter(w => !w.paused && !w.mastered).slice(0, Math.max(0, App.dailyNewLimit - dailyNewCount)).length;
        document.querySelectorAll('.mission-new-count').forEach(el => el.innerText = news);
        document.querySelectorAll('.mission-review-count').forEach(el => el.innerText = reviews);
    },
    renderGallery() {
        const container = document.getElementById('gallery-container'), mastered = App.db.filter(w => w.mastered).length;
        container.innerHTML = '';
        PET_DATA.forEach((p, idx) => {
            const unlocked = mastered >= p.t, div = document.createElement('div');
            div.className = `gallery-item ${unlocked ? 'unlocked' : 'locked'}`;
            div.onclick = () => { if (unlocked) UI.alert(p.n + " " + p.e, p.desc); else UI.alert("???", "ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚é€²åŒ–ã•ã›ã¦ã­ï¼"); };
            div.innerHTML = `<div class="emoji">${unlocked ? p.e : '?'}</div><div class="name">${unlocked ? `Lv.${idx+1}<br>${p.n}` : `Lv.${idx+1}<br>???`}</div>`;
            container.appendChild(div);
        });
    },
    renderWordbook() {
        const container = document.getElementById('wordbook-container'); container.innerHTML = '';
        [...App.db].sort((a,b) => a.w.localeCompare(b.w)).forEach(w => {
            const div = document.createElement('div'); div.className = 'word-item';
            div.innerHTML = `<div><div class="word-en">${w.w}</div><div class="word-jp">${w.m}</div></div><span class="tag lvl-${w.l}">${WORD_LEVELS[w.l]}</span>`;
            div.onclick = () => this.showWordDetail(w); container.appendChild(div);
        });
    },
    showWordDetail(word) {
        const modal = document.getElementById('custom-modal'), cancel = document.getElementById('modal-cancel');
        document.getElementById('modal-msg').innerHTML = word.w;
        document.getElementById('modal-content').innerHTML = `<div style="font-weight:bold; margin-bottom:15px; color:#666;">æ„å‘³: ${word.m}</div><button class="btn ai small" id="gen-sentence-btn" style="width:100%;">âœ¨ AIä¾‹æ–‡ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button><div id="detail-ai-box" class="ai-box">AIä¾‹æ–‡ã‚’ä½œæˆä¸­...</div>`;
        document.getElementById('modal-ok').classList.add('hidden'); cancel.innerText = "é–‰ã˜ã‚‹"; modal.classList.add('show');
        document.getElementById('gen-sentence-btn').onclick = async () => {
            const box = document.getElementById('detail-ai-box'); box.classList.add('show');
            const res = await Gemini.call(`Generate a simple English sentence for a child using "${word.w}". Format: English [break] Japanese`);
            box.innerText = res || "å¤±æ•—ã—ã¾ã—ãŸ";
        };
    },
    alert(title, text) {
        document.getElementById('modal-msg').innerText = title; document.getElementById('modal-content').innerText = text;
        const ok = document.getElementById('modal-ok'), cancel = document.getElementById('modal-cancel');
        ok.onclick = () => document.getElementById('custom-modal').classList.remove('show');
        ok.classList.remove('hidden'); cancel.classList.remove('hidden'); cancel.innerText = "é–‰ã˜ã‚‹";
        document.getElementById('custom-modal').classList.add('show');
    },
    confirm(title, text, onOk) {
        document.getElementById('modal-msg').innerText = title; document.getElementById('modal-content').innerText = text;
        const ok = document.getElementById('modal-ok'), cancel = document.getElementById('modal-cancel');
        ok.onclick = () => { onOk(); document.getElementById('custom-modal').classList.remove('show'); };
        ok.classList.remove('hidden'); cancel.classList.remove('hidden'); cancel.innerText = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        document.getElementById('custom-modal').classList.add('show');
    }
};

const Admin = {
    render() {
        document.getElementById('nickname-input').value = App.userNickname;
        document.getElementById('limit-new').value = App.dailyNewLimit;
        document.getElementById('limit-review').value = App.dailyReviewLimit;
        const table = document.getElementById('admin-table'); 
        table.innerHTML = `<tr><th>å˜èª</th><th>æ­£è§£ç‡</th><th>æ¬¡å›</th><th>æ“ä½œ</th></tr>`;
        
        [...App.db].sort((a,b) => a.l - b.l || a.w.localeCompare(b.w)).forEach(w => {
            const tr = document.createElement('tr'), acc = w.totalAttempts > 0 ? Math.round((w.correctCount/w.totalAttempts)*100) : 0;
            let next = "New"; if(w.nextReview > 0) { const d = Math.ceil((w.nextReview - Date.now()) / 86400000); next = d <= 0 ? "<span style='color:red;font-weight:bold;'>ä»Šæ—¥</span>" : d + "æ—¥å¾Œ"; }
            if(w.paused) tr.classList.add('paused-row');
            
            tr.innerHTML = `
                <td><b>${w.w}</b><br><small>${w.m}</small>${w.paused ? '<br><span class="paused-tag">åœæ­¢ä¸­</span>' : ''}</td>
                <td>${acc}%</td>
                <td>${next}</td>
                <td>
                    <div style="display:flex; flex-wrap:wrap; justify-content:center; width:64px; gap:2px;">
                        <button class="btn icon-btn outline" onclick="Admin.editItem('${w.w}')" title="ç·¨é›†">âœï¸</button>
                        <button class="btn icon-btn outline" onclick="Admin.togglePause('${w.w}')" title="${w.paused ? 'å†é–‹' : 'åœæ­¢'}">${w.paused ? 'â–¶ï¸' : 'â¸ï¸'}</button>
                        <button class="btn icon-btn outline" onclick="Admin.resetItem('${w.w}')" title="ãƒªã‚»ãƒƒãƒˆ">â†º</button>
                        <button class="btn icon-btn danger" onclick="Admin.deleteItem('${w.w}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </div>
                </td>`;
            table.appendChild(tr);
        });
    },
    saveNickname() { localStorage.setItem('spellquest_nickname', document.getElementById('nickname-input').value.trim()); App.userNickname = document.getElementById('nickname-input').value.trim(); UI.alert("æˆåŠŸ", "ä¿å­˜ã—ã¾ã—ãŸï¼"); },
    saveLimits() { App.dailyNewLimit = parseInt(document.getElementById('limit-new').value); App.dailyReviewLimit = parseInt(document.getElementById('limit-review').value); localStorage.setItem('spellquest_newLimit', App.dailyNewLimit); localStorage.setItem('spellquest_reviewLimit', App.dailyReviewLimit); UI.alert("æˆåŠŸ", "ä¿å­˜ã—ã¾ã—ãŸï¼"); UI.updateHome(); },
    saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value.trim()); App.apiKey = document.getElementById('api-key-input').value.trim(); UI.alert("æˆåŠŸ", "ä¿å­˜ã—ã¾ã—ãŸï¼"); },
    add() {
        const en = document.getElementById('add-en').value.trim(), jp = document.getElementById('add-jp').value.trim(), lvl = parseInt(document.getElementById('add-lvl').value);
        if(!en || !jp) return UI.alert("ã‚¨ãƒ©ãƒ¼", "å˜èªèˆ‡æ„å‘³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(App.db.find(w => w.w.toLowerCase() === en.toLowerCase())) return UI.alert("ã‚¨ãƒ©ãƒ¼", "é‡è¤‡ã—ã¦ã„ã¾ã™");
        App.db.push(App.createObj({w:en, m:jp, l:lvl}));
        App.save(); document.getElementById('add-en').value = ''; document.getElementById('add-jp').value = '';
        UI.alert("æˆåŠŸ", "è¿½åŠ ã—ã¾ã—ãŸï¼"); this.render(); UI.updateHome();
    },
    editItem(wordEn) {
        const word = App.db.find(w => w.w === wordEn);
        if(word) {
            const newEn = prompt("è‹±èªã‚’ç·¨é›†:", word.w), newJp = prompt("æ„å‘³ã‚’ç·¨é›†:", word.m);
            if(newEn && newJp) { word.w = newEn.trim(); word.m = newJp.trim(); App.save(); this.render(); }
        }
    },
    togglePause(wordEn) { const word = App.db.find(w => w.w === wordEn); if(word) { word.paused = !word.paused; App.save(); this.render(); UI.updateHome(); } },
    deleteItem(wordEn) { if(confirm(`ã€Œ${wordEn}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { App.db = App.db.filter(w => w.w !== wordEn); App.save(); this.render(); UI.updateHome(); } },
    exportCSV() {
        const todayStr = new Date().toISOString().split('T')[0], streak = localStorage.getItem('streak') || 0;
        const headers = ["Date", "Streak", "Word", "Meaning", "Level", "Correct", "Attempts", "Accuracy", "Interval", "LastReview"];
        let csvRows = [headers.join(",")];
        App.db.forEach(w => {
            const acc = w.totalAttempts > 0 ? ((w.correctCount / w.totalAttempts) * 100).toFixed(1) : 0;
            const lastRevDate = w.lastReviewTime ? new Date(w.lastReviewTime).toISOString().split('T')[0] : "Never";
            csvRows.push([todayStr, streak, w.w, `"${w.m}"`, w.l, w.correctCount, w.totalAttempts, acc, w.interval, lastRevDate].join(","));
        });
        const blob = new Blob(["\ufeff" + csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.setAttribute("href", URL.createObjectURL(blob)); 
        link.setAttribute("download", `study_report_${todayStr.replace(/-/g, '')}.csv`);
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    },
    // ã€ä¿®æ­£2ã€‘å¼·åˆ¶ä½¿ç”¨ UTF-8 è®€å– CSVï¼Œè§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œ
    processCSV(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result, lines = text.split(/\r?\n/);
            lines.forEach(l => {
                const p = l.split(','); if(p.length < 2) return;
                const existing = App.db.find(w => w.w.toLowerCase() === p[0].trim().toLowerCase());
                if(existing) { existing.m = p[1].trim(); existing.l = parseInt(p[2]) || 1; }
                else App.db.push(App.createObj({w: p[0].trim(), m: p[1].trim(), l: parseInt(p[2]) || 1}));
            });
            App.save(); Admin.render(); UI.updateHome(); UI.alert("å®Œäº†", "æˆåŠŸï¼");
        };
        reader.readAsText(file, "UTF-8"); 
    },
    resetItem(word) { const w = App.db.find(i => i.w === word); if(w) { Object.assign(w, {mastered: false, interval: 0, nextReview: 0, correctCount: 0, totalAttempts: 0}); App.save(); Admin.render(); } },
    resetAll() { UI.confirm("âš ï¸ è­¦å‘Š", "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ", () => { localStorage.clear(); location.reload(); }); }
};

App.init();
</script>
</body>
</html>

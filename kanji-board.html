<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°åª½çš„æ¼¢å­—æ‰‹å¯«æ¿</title>
    <style>
        /* --- Base Styles --- */
        body { font-family: "Hiragino Kaku Gothic Pro", "Yu Gothic", sans-serif; background-color: #f0f4f8; text-align: center; padding: 10px; color: #333; overscroll-behavior: none; margin: 0; }
        .container { max-width: 650px; margin: 0 auto; background: white; min-height: 95vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* Header & Nav */
        header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        h1 { color: #007bff; margin: 0; font-size: 1.2rem; font-weight: bold; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* --- Quiz UI --- */
        #quiz-view { padding: 20px 10px; flex: 1; }
        .progress-text { font-size: 0.9rem; color: #666; margin-bottom: 5px;}

        /* Canvas Area - Wide Rectangle */
        .canvas-container {
            position: relative;
            margin: 0 auto 15px auto;
            width: 100%;
            max-width: 600px;
            height: 220px;
            border: 3px solid #555;
            border-radius: 8px;
            background-color: #fff;
            touch-action: none; 
            cursor: crosshair;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* River Grid (Vertical Dashed Lines) */
        .grid-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
        }
        .grid-lines::before, .grid-lines::after {
            content: ""; position: absolute; top: 10px; bottom: 10px; width: 0; border-left: 2px dashed #ddd;
        }
        .grid-lines::before { left: 33.3%; }
        .grid-lines::after { left: 66.6%; }

        /* Question Display */
        .question-box { margin-bottom: 10px; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-text { font-size: 2.2rem; font-weight: bold; margin: 5px 0; letter-spacing: 2px; }
        .hint-text { font-size: 1rem; color: #d35400; background: #fff3e0; display: inline-block; padding: 3px 12px; border-radius: 15px; margin-top: 5px; }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
        .btn { font-size: 1rem; padding: 12px 24px; border: none; border-radius: 50px; cursor: pointer; color: white; min-width: 110px; box-shadow: 0 3px 0 rgba(0,0,0,0.1); font-weight: bold; transition: all 0.2s;}
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #2ecc71; }
        .btn-red { background-color: #e74c3c; }
        .btn-gray { background-color: #95a5a6; }
        .btn-yellow { background-color: #f1c40f; color: #333; }
        .btn-outline { background: transparent; border: 2px solid #3498db; color: #3498db; box-shadow: none; }
        
        .link-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px;
            color: #333; text-decoration: none; font-size: 0.95rem; text-align: center;
            transition: background 0.2s;
        }
        .link-btn:hover { background: #e2e6ea; }

        /* --- Admin Dashboard UI --- */
        #admin-view { display: none; padding: 20px; text-align: left; background: #fff; height: 100%; overflow-y: auto; padding-bottom: 50px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color:#555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .kanji-list { list-style: none; padding: 0; margin-top: 20px; }
        .kanji-item { background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .kanji-badge { background: #3498db; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; margin-right: 10px; font-size: 1.2rem; }
        .delete-btn { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0 10px; }
        
        /* Manual Input specific */
        .manual-word-block { background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #ddd; }
        .manual-word-label { font-weight: bold; color: #007bff; margin-bottom: 5px; font-size: 0.9rem; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }
        
        /* Footer Links Section */
        .resource-links { margin-top: 30px; padding-top: 20px; border-top: 2px dashed #eee; }
        .resource-links h4 { margin: 0 0 10px 0; color: #555; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ–ï¸ å°åª½çš„æ¼¢å­—æ‰‹å¯«æ¿</h1>
        <button class="settings-btn" onclick="toggleAdmin()">âš™ï¸ è¨­å®š</button>
    </header>

    <!-- === STUDENT VIEW === -->
    <div id="quiz-view">
        <!-- Start Screen -->
        <div id="start-screen">
            <div style="margin: 40px 20px; text-align: left; background: #e8f4fd; padding: 20px; border-radius: 10px;">
                <h3 style="margin-top:0;">æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ</h3>
                <p>ç›®å‰é¡Œåº«å…±æœ‰ <strong id="total-count">0</strong> å€‹æ¼¢å­—ã€‚</p>
                <p>1. è½èªéŸ³ï¼Œçœ‹æç¤ºã€‚</p>
                <p>2. åœ¨æ ¼å­è£¡å¯«å‡ºæ­£ç¢ºçš„ç†Ÿèªã€‚</p>
                <p>3. å¯«å®ŒæŒ‰ã€Œçœ‹ç­”æ¡ˆã€ï¼Œå°ç…§ä¸‹æ–¹çš„æ­£ç¢ºå­—ã€‚</p>
            </div>
            <button class="btn btn-blue" style="width: 80%;" onclick="startQuiz()">é–‹å§‹ç·´ç¿’ (ã‚¹ã‚¿ãƒ¼ãƒˆ)</button>
        </div>

        <!-- Quiz Interface -->
        <div id="quiz-interface" class="hidden">
            <div class="progress-text">ç¬¬ <span id="current-num">1</span> / <span id="total-q"></span> é¡Œ</div>
            
            <div class="question-box">
                <button class="btn btn-yellow" style="padding: 5px 15px; font-size: 0.9rem; margin-bottom:5px;" onclick="speakQuestion()">ğŸ”Š æ’­æ”¾è²éŸ³</button>
                <div class="question-text" id="q-kana"></div>
                <div class="hint-text" id="q-hint"></div>
            </div>

            <!-- Handwriting Canvas -->
            <div class="canvas-container" id="canvas-wrapper">
                <div class="grid-lines"></div>
                <canvas id="drawing-board"></canvas>
            </div>

            <!-- Phase 1 Controls -->
            <div id="draw-controls" class="controls">
                <button class="btn btn-gray" onclick="clearCanvas()">é‡å¯«</button>
                <button class="btn btn-blue" onclick="showAnswer()">çœ‹ç­”æ¡ˆ</button>
            </div>

            <!-- Phase 2 Controls -->
            <div id="judge-controls" class="controls hidden">
                <button class="btn btn-green" onclick="recordResult(true)">â­• å¯«å°äº†</button>
                <button class="btn btn-red" onclick="recordResult(false)">âŒ å¯«éŒ¯äº†</button>
            </div>
            
            <!-- Details -->
            <div id="answer-details" style="margin-top: 15px; display: none; background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: left; border: 2px solid #eee;">
                <div style="text-align: center; margin-bottom: 10px;">
                    <span style="font-size: 3.5rem; font-weight: bold; color:#e74c3c; font-family: serif; letter-spacing: 5px;" id="ans-word"></span>
                </div>
                <div style="color: #555; font-size: 1rem; text-align: center;" id="ans-info"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden">
            <h2>ç·´ç¿’çµæŸï¼</h2>
            <div style="font-size: 2.5rem; color: #3498db; margin: 15px 0; font-weight:bold;" id="score-display"></div>
            
            <div style="text-align: left; margin-top: 20px;">
                <p style="background:#eee; padding:8px; border-radius:5px; font-weight:bold;">ğŸ‘‡ éœ€è¦åŠ å¼·çš„å­— (è«‹æŠ„å¯«åœ¨ç­†è¨˜æœ¬ä¸Š)</p>
                <div id="wrong-list"></div>
            </div>
            <button class="btn btn-blue" style="margin-top: 30px;" onclick="location.reload()">å†è€ƒä¸€æ¬¡</button>
        </div>
    </div>

    <!-- === ADMIN VIEW (MANUAL) === -->
    <div id="admin-view">
        <div class="admin-header">
            <h2 style="margin:0;">âš™ï¸ å®¶é•·ç®¡ç†å¾Œå°</h2>
            <button class="btn btn-gray" style="min-width:auto; padding: 5px 15px;" onclick="toggleAdmin()">é—œé–‰</button>
        </div>

        <!-- Manual Add Kanji Section -->
        <div class="form-group" style="background: #eef; padding: 15px; border-radius: 8px; border:1px solid #ddd;">
            <h3 style="margin-top:0; color:#007bff; font-size:1.1rem;">â• æ–°å¢/ç·¨è¼¯ æ¼¢å­— (æ‰‹å‹•è¼¸å…¥)</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:15px;">
                <div>
                    <label>æ¼¢å­—</label>
                    <input type="text" id="manual-char" class="form-control" placeholder="ä¾‹ï¼šæ„›">
                </div>
                <div>
                    <label>éŸ³è®€ (ç‰‡å‡)</label>
                    <input type="text" id="manual-on" class="form-control" placeholder="ä¾‹ï¼šã‚¢ã‚¤">
                </div>
                <div>
                    <label>è¨“è®€ (å¹³å‡)</label>
                    <input type="text" id="manual-kun" class="form-control" placeholder="ä¾‹ï¼šã„ã¨">
                </div>
            </div>

            <label style="margin-bottom:10px; display:block;">ğŸ‘‡ è«‹è¼¸å…¥ 1~3 å€‹å¸¸ç”¨ç†Ÿèª</label>
            
            <div id="word-inputs">
                <!-- Word 1 -->
                <div class="manual-word-block">
                    <div class="manual-word-label">è©å½™ 1</div>
                    <input type="text" id="w1-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª (ä¾‹: æ„›æƒ…)">
                    <input type="text" id="w1-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³ (ä¾‹: ã‚ã„ã˜ã‚‡ã†)">
                    <input type="text" id="w1-h" class="form-control" placeholder="æç¤º (ä¾‹: æ·±ãæ„›ã™ã‚‹å¿ƒ)">
                </div>
                <!-- Word 2 -->
                <div class="manual-word-block">
                     <div class="manual-word-label">è©å½™ 2 (é¸å¡«)</div>
                    <input type="text" id="w2-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª">
                    <input type="text" id="w2-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³">
                    <input type="text" id="w2-h" class="form-control" placeholder="æç¤º">
                </div>
                <!-- Word 3 -->
                <div class="manual-word-block">
                     <div class="manual-word-label">è©å½™ 3 (é¸å¡«)</div>
                    <input type="text" id="w3-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª">
                    <input type="text" id="w3-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³">
                    <input type="text" id="w3-h" class="form-control" placeholder="æç¤º">
                </div>
            </div>

            <button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="addKanjiManual()">æ–°å¢è‡³é¡Œåº«</button>
        </div>

        <!-- List Section -->
        <div style="margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ç›®å‰é¡Œåº« (<span id="db-count">0</span>)</h3>
                <button class="btn btn-outline" style="font-size:0.8rem; min-width:auto; padding:5px 10px;" onclick="resetDefaultData()">é‡ç½®å›é è¨­56å­—</button>
            </div>
            <ul class="kanji-list" id="admin-list">
                <!-- Items injected here -->
            </ul>
        </div>

        <!-- Resources Links Section -->
        <div class="resource-links">
            <h4>ğŸ”— å°åª½è³‡æºé€£çµ</h4>
            <a href="https://twmama.notion.site/supportme?source=copy_link" target="_blank" class="link-btn">
                â˜• æ”¯æŒæˆ‘è£½ä½œæ›´å¤šå¤šèªè³‡æº
            </a>
            <a href="https://twmama.notion.site/resources-hub?source=copy_link" target="_blank" class="link-btn">
                ğŸ“š æ›´å¤šå…è²»è³‡æºï¼šå°åª½æ—¥çˆ¸æ¨‚å…±è®€
            </a>
        </div>
    </div>
</div>

<script>
    // --- Initial Data (The 56 Original Kanji) ---
    const defaultData = [
        { char: "ä»¤", on: "ãƒ¬ã‚¤", kun: "-", words: [{w:"å‘½ä»¤", k:"ã‚ã„ã‚Œã„", h:"ä¸Šã®äººãŒè¨€ã„ã¤ã‘ã‚‹"}, {w:"å·ä»¤", k:"ã”ã†ã‚Œã„", h:"å…¨ä½“ã«ã‹ã‘ã‚‹è¨€è‘‰"}, {w:"ä»¤å’Œ", k:"ã‚Œã„ã‚", h:"ä»Šã®å¹´å·"}] },
        { char: "ä½", on: "ã‚¤", kun: "ãã‚‰ã„", words: [{w:"ä¸€ä½", k:"ã„ã¡ã„", h:"ç«¶äº‰ã§ä¸€ç•ªã«ãªã‚‹"}, {w:"åœ°ä½", k:"ã¡ã„", h:"ç¤¾ä¼šçš„ãªç«‹å ´"}, {w:"å„ä½", k:"ã‹ãã„", h:"çš†æ§˜"}] },
        { char: "ç½®", on: "ãƒ", kun: "ãŠ(ã)", words: [{w:"ä½ç½®", k:"ã„ã¡", h:"å ´æ‰€"}, {w:"ç‰©ç½®", k:"ã‚‚ã®ãŠã", h:"é“å…·ã‚’å…¥ã‚Œã‚‹å€‰åº«"}, {w:"ç½®ã", k:"ãŠã", h:"æœºã®ä¸Šã«æœ¬ã‚’ï½"}] },
        { char: "æ¼", on: "ã‚®ãƒ§", kun: "-", words: [{w:"æ¼æ¥­", k:"ãã‚‡ãã‚‡ã†", h:"é­šã‚’ã¨ã‚‹ç”£æ¥­"}, {w:"æ¼å¸«", k:"ã‚Šã‚‡ã†ã—", h:"é­šã‚’ã¨ã‚‹ä»•äº‹ã®äºº"}, {w:"å¤§æ¼", k:"ãŸã„ã‚Šã‚‡ã†", h:"é­šãŒãŸãã•ã‚“ã¨ã‚Œã‚‹"}] },
        { char: "æµ´", on: "ãƒ¨ã‚¯", kun: "ã‚(ã³ã‚‹)", words: [{w:"æµ·æ°´æµ´", k:"ã‹ã„ã™ã„ã‚ˆã", h:"å¤ã«æµ·ã§æ³³ã"}, {w:"æ—¥å…‰æµ´", k:"ã«ã£ã“ã†ã‚ˆã", h:"å¤ªé™½ã®å…‰ã«ã‚ãŸã‚‹"}, {w:"æµ´ã³ã‚‹", k:"ã‚ã³ã‚‹", h:"ã‚·ãƒ£ãƒ¯ãƒ¼ã‚’ï½"}] },
        { char: "æ¬ ", on: "ã‚±ãƒ„", kun: "ã‹(ã‘ã‚‹)", words: [{w:"æ¬ å¸­", k:"ã‘ã£ã›ã", h:"å­¦æ ¡ã‚’ä¼‘ã‚€"}, {w:"æ¬ ç‚¹", k:"ã‘ã£ã¦ã‚“", h:"æ‚ªã„ã¨ã“ã‚"}, {w:"ä¸å¯æ¬ ", k:"ãµã‹ã‘ã¤", h:"çµ¶å¯¾ã«å¿…è¦ãªã“ã¨"}] },
        { char: "å’", on: "ã‚½ãƒ„", kun: "-", words: [{w:"å’æ¥­", k:"ãã¤ãã‚‡ã†", h:"å­¦æ ¡ã‚’çµ‚ãˆã‚‹"}, {w:"æ–°å’", k:"ã—ã‚“ãã¤", h:"å­¦æ ¡ã‚’å‡ºãŸã°ã‹ã‚Šã®äºº"}, {w:"ä½•å’", k:"ãªã«ã¨ã", h:"ãŠé¡˜ã„ã—ã¾ã™"}] },
        { char: "å˜", on: "ã‚¿ãƒ³", kun: "-", words: [{w:"ç°¡å˜", k:"ã‹ã‚“ãŸã‚“", h:"ã‚€ãšã‹ã—ããªã„"}, {w:"å˜èª", k:"ãŸã‚“ã”", h:"è¨€è‘‰ã®ã²ã¨ã¾ã¨ã¾ã‚Š"}, {w:"å˜ä½", k:"ãŸã‚“ã„", h:"ãƒ¡ãƒ¼ãƒˆãƒ«ã‚„ã‚°ãƒ©ãƒ ãªã©"}] },
        { char: "çµ", on: "ã‚±ãƒ„", kun: "ã‚€ã™(ã¶)", words: [{w:"çµå©š", k:"ã‘ã£ã“ã‚“", h:"å¤«å©¦ã«ãªã‚‹"}, {w:"çµæœ", k:"ã‘ã£ã‹", h:"ç‰©äº‹ã®çµ‚ã‚ã‚Š"}, {w:"çµã¶", k:"ã‚€ã™ã¶", h:"ã²ã‚‚ã‚’ï½"}] },
        { char: "æœ", on: "ã‚«", kun: "ã¯(ãŸã™)", words: [{w:"æœå®Ÿ", k:"ã‹ã˜ã¤", h:"æœ¨ã®å®Ÿ"}, {w:"æˆæœ", k:"ã›ã„ã‹", h:"ã‚ˆã„å‡ºæ¥æ „ãˆ"}, {w:"æœãŸã™", k:"ã¯ãŸã™", h:"ç´„æŸã‚’å®ˆã‚Šåˆ‡ã‚‹"}] },
        { char: "å¾„", on: "ã‚±ã‚¤", kun: "-", words: [{w:"ç›´å¾„", k:"ã¡ã‚‡ã£ã‘ã„", h:"å††ã®ä¸­å¿ƒã‚’é€šã‚‹ç·š"}, {w:"åŠå¾„", k:"ã¯ã‚“ã‘ã„", h:"ä¸­å¿ƒã‹ã‚‰å††ã®ç«¯ã¾ã§"}, {w:"å°å¾„", k:"ã“ã¿ã¡", h:"ç´°ã„é“"}] },
        { char: "å‰¯", on: "ãƒ•ã‚¯", kun: "-", words: [{w:"å‰¯ç¤¾é•·", k:"ãµãã—ã‚ƒã¡ã‚‡ã†", h:"ç¤¾é•·ã®æ¬¡ã®äºº"}, {w:"å‰¯ä½œç”¨", k:"ãµãã•ã‚ˆã†", h:"è–¬ã®åˆ¥ã®åƒã"}, {w:"å‰¯è³", k:"ãµãã—ã‚‡ã†", h:"ãŠã¾ã‘ã®è³å“"}] },
        { char: "è‡£", on: "ã‚·ãƒ³", kun: "-", words: [{w:"å¤§è‡£", k:"ã ã„ã˜ã‚“", h:"å†…é–£ã®ãƒ¡ãƒ³ãƒãƒ¼"}, {w:"è‡£ä¸‹", k:"ã—ã‚“ã‹", h:"å®¶æ¥"}, {w:"è‡£æ°‘", k:"ã—ã‚“ã¿ã‚“", h:"æ˜”ã®è¨€è‘‰ã§å›½æ°‘"}] },
        { char: "è¡—", on: "ã‚¬ã‚¤", kun: "ã¾ã¡", words: [{w:"å•†åº—è¡—", k:"ã—ã‚‡ã†ã¦ã‚“ãŒã„", h:"åº—ãŒä¸¦ã¶é€šã‚Š"}, {w:"å¸‚è¡—åœ°", k:"ã—ãŒã„ã¡", h:"å®¶ã‚„åº—ãŒå¤šã„æ‰€"}, {w:"è¡—è§’", k:"ã¾ã¡ã‹ã©", h:"é“ã®æ›²ãŒã‚Šè§’"}] },
        { char: "ç¯", on: "ãƒˆã‚¦", kun: "-", words: [{w:"ç¯å°", k:"ã¨ã†ã ã„", h:"æµ·ã‚’ç…§ã‚‰ã™å¡”"}, {w:"é›»ç¯", k:"ã§ã‚“ã¨ã†", h:"é›»æ°—ã®æ˜ã‹ã‚Š"}, {w:"è¡—ç¯", k:"ãŒã„ã¨ã†", h:"é“è·¯ã«ã‚ã‚‹æ˜ã‹ã‚Š"}] },
        { char: "è‹±", on: "ã‚¨ã‚¤", kun: "-", words: [{w:"è‹±èª", k:"ãˆã„ã”", h:"å¤–å›½ã®è¨€è‘‰"}, {w:"è‹±å›½", k:"ãˆã„ã“ã", h:"ã‚¤ã‚®ãƒªã‚¹ã®ã“ã¨"}, {w:"è‹±é›„", k:"ãˆã„ã‚†ã†", h:"ãƒ’ãƒ¼ãƒ­ãƒ¼"}] },
        { char: "å‚", on: "ã‚µãƒ³", kun: "ã¾ã„(ã‚‹)", words: [{w:"å‚åŠ ", k:"ã•ã‚“ã‹", h:"ä»²é–“ã«å…¥ã‚‹ã“ã¨"}, {w:"å‚è€ƒ", k:"ã•ã‚“ã“ã†", h:"è€ƒãˆã®åŠ©ã‘ã«ã™ã‚‹"}, {w:"å‚ã‚‹", k:"ã¾ã„ã‚‹", h:"ç¥ç¤¾ã¸è¡Œã"}] },
        { char: "å”±", on: "ã‚·ãƒ§ã‚¦", kun: "ã¨ãª(ãˆã‚‹)", words: [{w:"åˆå”±", k:"ãŒã£ã—ã‚‡ã†", h:"ã¿ã‚“ãªã§æ­Œã†"}, {w:"ç‹¬å”±", k:"ã©ãã—ã‚‡ã†", h:"ä¸€äººã§æ­Œã†"}, {w:"å”±ãˆã‚‹", k:"ã¨ãªãˆã‚‹", h:"å‘ªæ–‡ã‚’å£ã«å‡ºã™"}] },
        { char: "å¡©", on: "ã‚¨ãƒ³", kun: "ã—ãŠ", words: [{w:"é£Ÿå¡©", k:"ã—ã‚‡ããˆã‚“", h:"æ–™ç†ã«ä½¿ã†ç™½ã„ç²‰"}, {w:"å¡©åˆ†", k:"ãˆã‚“ã¶ã‚“", h:"ã—ã‚‡ã£ã±ã„æˆåˆ†"}, {w:"å¡©", k:"ã—ãŠ", h:"å‘³ä»˜ã‘ã«ä½¿ã†"}] },
        { char: "æ²»", on: "ã‚¸ã€ãƒ", kun: "ãŠã•(ã‚ã‚‹)", words: [{w:"æ”¿æ²»", k:"ã›ã„ã˜", h:"å›½ã‚’å‹•ã‹ã™ã“ã¨"}, {w:"æ²»ç™‚", k:"ã¡ã‚Šã‚‡ã†", h:"ç—…æ°—ã‚’ãªãŠã™"}, {w:"æ²»ã‚ã‚‹", k:"ãŠã•ã‚ã‚‹", h:"å›½ã‚’ï½"}] },
        { char: "åˆ·", on: "ã‚µãƒ„", kun: "ã™(ã‚‹)", words: [{w:"å°åˆ·", k:"ã„ã‚“ã•ã¤", h:"ç´™ã«ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹"}, {w:"åˆ·æ–°", k:"ã•ã£ã—ã‚“", h:"å…¨ãæ–°ã—ãã™ã‚‹ã“ã¨"}, {w:"åˆ·ã‚‹", k:"ã™ã‚‹", h:"ãƒã‚¹ã‚¿ãƒ¼ã‚’ï½"}] },
        { char: "å¤‰", on: "ãƒ˜ãƒ³", kun: "ã‹(ã‚ã‚‹)", words: [{w:"å¤‰åŒ–", k:"ã¸ã‚“ã‹", h:"ã‚ˆã†ã™ã®ç§»ã‚Šå¤‰ã‚ã‚Š"}, {w:"å¤§å¤‰", k:"ãŸã„ã¸ã‚“", h:"è‹¦åŠ´ã™ã‚‹"}, {w:"å¤‰ã‚ã‚‹", k:"ã‹ã‚ã‚‹", h:"ä¿¡å·ã®è‰²ãŒï½"}] },
        { char: "æœ«", on: "ãƒãƒ„", kun: "ã™ãˆ", words: [{w:"å¹´æœ«", k:"ã­ã‚“ã¾ã¤", h:"å¹´ã®çµ‚ã‚ã‚Š"}, {w:"çµæœ«", k:"ã‘ã¤ã¾ã¤", h:"ç‰©èªã®æœ€å¾Œ"}, {w:"æœ«ã£å­", k:"ã™ãˆã£ã“", h:"ä¸€ç•ªä¸‹ã®å­"}] },
        { char: "ç¨®", on: "ã‚·ãƒ¥", kun: "ãŸã­", words: [{w:"ç¨®é¡", k:"ã—ã‚…ã‚‹ã„", h:"ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘"}, {w:"äººç¨®", k:"ã˜ã‚“ã—ã‚…", h:"äººã®åŒºåˆ†"}, {w:"ç¨®ã¾ã", k:"ãŸã­ã¾ã", h:"ç•‘ã«ã¾ãã“ã¨"}] },
        { char: "ç¶š", on: "ã‚¾ã‚¯", kun: "ã¤ã¥(ã)", words: [{w:"é€£ç¶š", k:"ã‚Œã‚“ãã", h:"é€”åˆ‡ã‚Œãªã„ã“ã¨"}, {w:"æ¥ç¶š", k:"ã›ã¤ãã", h:"ã¤ãªãã“ã¨"}, {w:"ç¶šã", k:"ã¤ã¥ã", h:"é“ãŒï½"}] },
        { char: "æŠ˜", on: "ã‚»ãƒ„", kun: "ãŠ(ã‚‹)", words: [{w:"éª¨æŠ˜", k:"ã“ã£ã›ã¤", h:"éª¨ãŒæŠ˜ã‚Œã‚‹"}, {w:"å³æŠ˜", k:"ã†ã›ã¤", h:"å³ã«æ›²ãŒã‚‹"}, {w:"æŠ˜ã‚Šç´™", k:"ãŠã‚ŠãŒã¿", h:"é¶´ãªã©ã‚’ä½œã‚‹éŠã³"}] },
        { char: "ç©", on: "ã‚»ã‚­", kun: "ã¤(ã‚€)", words: [{w:"é¢ç©", k:"ã‚ã‚“ã›ã", h:"åºƒã•"}, {w:"ç©é›ª", k:"ã›ãã›ã¤", h:"é›ªãŒãµã‚Šã¤ã‚‚ã‚‹"}, {w:"ç©ã¿æœ¨", k:"ã¤ã¿ã", h:"æœ¨ã®ãŠã‚‚ã¡ã‚ƒ"}] },
        { char: "æ¾", on: "ã‚·ãƒ§ã‚¦", kun: "ã¾ã¤", words: [{w:"æ¾ç«¹æ¢…", k:"ã—ã‚‡ã†ã¡ãã°ã„", h:"ãŠç¥ã„ã®ï¼“ã¤ã®æœ¨"}, {w:"æ¾æ—", k:"ã¾ã¤ã°ã‚„ã—", h:"æµ·å²¸ãªã©ã«ã‚ã‚‹æ—"}, {w:"é–€æ¾", k:"ã‹ã©ã¾ã¤", h:"æ­£æœˆã«é£¾ã‚‹ã‚‚ã®"}] },
        { char: "ä¸", on: "ãƒ•", kun: "-", words: [{w:"ä¸è¶³", k:"ãµãã", h:"è¶³ã‚Šãªã„ã“ã¨"}, {w:"ä¸ä¾¿", k:"ãµã¹ã‚“", h:"ä¾¿åˆ©ã˜ã‚ƒãªã„"}, {w:"ä¸æ€è­°", k:"ãµã—ã", h:"ç†ç”±ãŒã‚ã‹ã‚‰ãªã„"}] },
        { char: "è­°", on: "ã‚®", kun: "-", words: [{w:"ä¼šè­°", k:"ã‹ã„ã", h:"é›†ã¾ã£ã¦è©±ã—åˆã†"}, {w:"è­°å“¡", k:"ãã„ã‚“", h:"é¸æŒ™ã§é¸ã°ã‚ŒãŸäºº"}, {w:"è­°é¡Œ", k:"ãã ã„", h:"è©±ã—åˆã†ãƒ†ãƒ¼ãƒ"}] },
        { char: "å·®", on: "ã‚µ", kun: "ã•(ã™)", words: [{w:"äº¤å·®ç‚¹", k:"ã“ã†ã•ã¦ã‚“", h:"é“ãŒäº¤ã‚ã‚‹ã¨ã“ã‚"}, {w:"æ™‚å·®", k:"ã˜ã•", h:"æ™‚é–“ã®ãšã‚Œ"}, {w:"æ—¥å·®ã—", k:"ã²ã–ã—", h:"å¤ªé™½ã®å…‰"}] },
        { char: "å¿µ", on: "ãƒãƒ³", kun: "-", words: [{w:"è¨˜å¿µ", k:"ãã­ã‚“", h:"æ€ã„å‡ºã«æ®‹ã™"}, {w:"æ®‹å¿µ", k:"ã–ã‚“ã­ã‚“", h:"ãã‚„ã—ã„æ°—æŒã¡"}, {w:"å¿µé¡˜", k:"ã­ã‚“ãŒã‚“", h:"ãšã£ã¨æœ›ã‚“ã§ã„ãŸã“ã¨"}] },
        { char: "å›º", on: "ã‚³", kun: "ã‹ãŸ(ã¾ã‚‹)", words: [{w:"å›ºå®š", k:"ã“ã¦ã„", h:"å‹•ã‹ãªã„ã‚ˆã†ã«ã™ã‚‹"}, {w:"é ‘å›º", k:"ãŒã‚“ã“", h:"æ„åœ°ã£å¼µã‚Šãªã“ã¨"}, {w:"å›ºã¾ã‚‹", k:"ã‹ãŸã¾ã‚‹", h:"ã‚¼ãƒªãƒ¼ãªã©ãŒï½"}] },
        { char: "ä¾¿", on: "ãƒ™ãƒ³", kun: "ãŸã‚ˆ(ã‚Š)", words: [{w:"ä¾¿åˆ©", k:"ã¹ã‚“ã‚Š", h:"å½¹ã«ç«‹ã¤ã“ã¨"}, {w:"éƒµä¾¿", k:"ã‚†ã†ã³ã‚“", h:"æ‰‹ç´™ã‚’é€ã‚‹ä»•çµ„ã¿"}, {w:"ä¾¿ã‚Š", k:"ãŸã‚ˆã‚Š", h:"æ‰‹ç´™ã‚„çŸ¥ã‚‰ã›"}] },
        { char: "åš", on: "ãƒã‚¯", kun: "-", words: [{w:"åšå£«", k:"ã¯ã‹ã›", h:"ç‰©çŸ¥ã‚Šãªäºº"}, {w:"åšç‰©é¤¨", k:"ã¯ãã¶ã¤ã‹ã‚“", h:"å¤ã„ç‰©ã‚’å±•ç¤ºã™ã‚‹å ´æ‰€"}, {w:"åšæ„›", k:"ã¯ãã‚ã„", h:"åºƒãå¹³ç­‰ã«æ„›ã™ã‚‹"}] },
        { char: "æµ…", on: "ã‚»ãƒ³", kun: "ã‚ã•(ã„)", words: [{w:"æµ…æµ·", k:"ã›ã‚“ã‹ã„", h:"æ·±ããªã„æµ·"}, {w:"é æµ…", k:"ã¨ãŠã‚ã•", h:"é ãã¾ã§æ·±ããªã„"}, {w:"æµ…ã„", k:"ã‚ã•ã„", h:"ãƒ—ãƒ¼ãƒ«ãŒï½"}] },
        { char: "å€‰", on: "ã‚½ã‚¦", kun: "ãã‚‰", words: [{w:"å€‰åº«", k:"ãã†ã“", h:"è·ç‰©ã‚’ã—ã¾ã£ã¦ãŠãå»ºç‰©"}, {w:"ç©€å€‰", k:"ã“ããã†", h:"ãŠç±³ãªã©ã‚’å…¥ã‚Œã‚‹"}, {w:"å€‰", k:"ãã‚‰", h:"æ˜”ã®ä¿ç®¡åº«"}] },
        { char: "æœ­", on: "ã‚µãƒ„", kun: "ãµã ", words: [{w:"åæœ­", k:"ãªãµã ", h:"åå‰ã‚’æ›¸ã„ãŸã‚«ãƒ¼ãƒ‰"}, {w:"åƒå††æœ­", k:"ã›ã‚“ãˆã‚“ã•ã¤", h:"ç´™ã®ãŠé‡‘"}, {w:"æ”¹æœ­å£", k:"ã‹ã„ã•ã¤ãã¡", h:"é§…ã§åˆ‡ç¬¦ã‚’é€šã™æ‰€"}] },
        { char: "å­«", on: "ã‚½ãƒ³", kun: "ã¾ã”", words: [{w:"å­å­«", k:"ã—ãã‚“", h:"ä»£ã€…ã®å­ä¾›ãŸã¡"}, {w:"å­«å¨˜", k:"ã¾ã”ã‚€ã™ã‚", h:"å¥³ã®å­ã®ã¾ã”"}, {w:"å­«", k:"ã¾ã”", h:"å­ä¾›ã®å­ä¾›"}] },
        { char: "åŠŸ", on: "ã‚³ã‚¦", kun: "-", words: [{w:"æˆåŠŸ", k:"ã›ã„ã“ã†", h:"ã†ã¾ãã„ãã“ã¨"}, {w:"åŠŸç¸¾", k:"ã“ã†ã›ã", h:"ç«‹æ´¾ãªåƒã"}, {w:"åŠŸåŠ´", k:"ã“ã†ã‚ã†", h:"è‹¦åŠ´ã—ã¦å°½ãã—ãŸã“ã¨"}] },
        { char: "åŠ ", on: "ã‚«", kun: "ãã‚(ãˆã‚‹)", words: [{w:"å‚åŠ ", k:"ã•ã‚“ã‹", h:"è¡Œäº‹ã«åŠ ã‚ã‚‹"}, {w:"è¿½åŠ ", k:"ã¤ã„ã‹", h:"å¾Œã‹ã‚‰è¶³ã™ã“ã¨"}, {w:"åŠ ãˆã‚‹", k:"ãã‚ãˆã‚‹", h:"å¡©ã‚’ï½"}] },
        { char: "ç‰§", on: "ãƒœã‚¯", kun: "ã¾ã", words: [{w:"ç‰§å ´", k:"ã¼ãã˜ã‚‡ã†", h:"ç‰›ã‚„é¦¬ãŒã„ã‚‹æ‰€"}, {w:"éŠç‰§", k:"ã‚†ã†ã¼ã", h:"ç§»å‹•ã—ãªãŒã‚‰å®¶ç•œã‚’é£¼ã†"}, {w:"ç‰§å ´", k:"ã¾ãã°", h:"ç‰›ãŒã„ã‚‹åºƒå ´(è¨“èª­ã¿)"}] },
        { char: "å€Ÿ", on: "ã‚·ãƒ£ã‚¯", kun: "ã‹(ã‚Šã‚‹)", words: [{w:"å€Ÿé‡‘", k:"ã—ã‚ƒã£ãã‚“", h:"ãŠé‡‘ã‚’å€Ÿã‚Šã‚‹ã“ã¨"}, {w:"å€Ÿç”¨", k:"ã—ã‚ƒãã‚ˆã†", h:"å€Ÿã‚Šã¦ä½¿ã†ã“ã¨"}, {w:"å€Ÿã‚Šã‚‹", k:"ã‹ã‚Šã‚‹", h:"å›³æ›¸é¤¨ã§æœ¬ã‚’ï½"}] },
        { char: "æŒ™", on: "ã‚­ãƒ§", kun: "ã‚(ã’ã‚‹)", words: [{w:"é¸æŒ™", k:"ã›ã‚“ãã‚‡", h:"ä»£è¡¨ã‚’æŠ•ç¥¨ã§é¸ã¶"}, {w:"æŒ™æ‰‹", k:"ãã‚‡ã—ã‚…", h:"æ‰‹ã‚’ã‚ã’ã‚‹ã“ã¨"}, {w:"æŒ™ã’ã‚‹", k:"ã‚ã’ã‚‹", h:"æ‰‹ã‚’ï½"}] },
        { char: "å”", on: "ã‚­ãƒ§ã‚¦", kun: "-", words: [{w:"å”åŠ›", k:"ãã‚‡ã†ã‚Šã‚‡ã", h:"åŠ›ã‚’åˆã‚ã›ã‚‹"}, {w:"å”ä¼š", k:"ãã‚‡ã†ã‹ã„", h:"ã‚ã‚‹ç›®çš„ã®ã‚°ãƒ«ãƒ¼ãƒ—"}, {w:"å”å®š", k:"ãã‚‡ã†ã¦ã„", h:"å›½å®¶é–“ã®å–ã‚Šæ±ºã‚"}] },
        { char: "æ¥µ", on: "ã‚­ãƒ§ã‚¯", kun: "ãã‚(ã‚ã‚‹)", words: [{w:"åŒ—æ¥µ", k:"ã»ã£ãã‚‡ã", h:"åœ°çƒã®ä¸€ç•ªåŒ—"}, {w:"ç©æ¥µçš„", k:"ã›ã£ãã‚‡ãã¦ã", h:"é€²ã‚“ã§ã‚„ã‚‹ã“ã¨"}, {w:"æ¥µã‚ã‚‹", k:"ãã‚ã‚ã‚‹", h:"é ‚ç‚¹ã«é”ã™ã‚‹"}] },
        { char: "æ±‚", on: "ã‚­ãƒ¥ã‚¦", kun: "ã‚‚ã¨(ã‚ã‚‹)", words: [{w:"è¦æ±‚", k:"ã‚ˆã†ãã‚…ã†", h:"å¿…è¦ã ã¨è¨€ã†ã“ã¨"}, {w:"æ±‚äºº", k:"ãã‚…ã†ã˜ã‚“", h:"åƒãæ‰‹ã‚’ã•ãŒã™ã“ã¨"}, {w:"æ±‚ã‚ã‚‹", k:"ã‚‚ã¨ã‚ã‚‹", h:"å¹³å’Œã‚’ï½"}] },
        { char: "æœª", on: "ãƒŸ", kun: "-", words: [{w:"æœªæ¥", k:"ã¿ã‚‰ã„", h:"ã“ã‚Œã‹ã‚‰æ¥ã‚‹ã“ã¨"}, {w:"æœªæº€", k:"ã¿ã¾ã‚“", h:"ã‚ã‚‹æ•°ã‚ˆã‚Šå°ã•ã„"}, {w:"æœªå®š", k:"ã¿ã¦ã„", h:"ã¾ã æ±ºã¾ã£ã¦ã„ãªã„"}] },
        { char: "èŠ¸", on: "ã‚²ã‚¤", kun: "-", words: [{w:"èŠ¸è¡“", k:"ã’ã„ã˜ã‚…ã¤", h:"éŸ³æ¥½ã‚„ç¾è¡“ãªã©"}, {w:"èŠ¸èƒ½", k:"ã’ã„ã®ã†", h:"ãƒ†ãƒ¬ãƒ“ã«å‡ºã‚‹äººãªã©"}, {w:"åœ’èŠ¸", k:"ãˆã‚“ã’ã„", h:"èŠ±ã‚„è‰æœ¨ã‚’è‚²ã¦ã‚‹"}] },
        { char: "å„", on: "ã‚«ã‚¯", kun: "ãŠã®ãŠã®", words: [{w:"å„è‡ª", k:"ã‹ãã˜", h:"ã²ã¨ã‚Šã²ã¨ã‚Š"}, {w:"å„å›½", k:"ã‹ã£ã“ã", h:"ãã‚Œãã‚Œã®å›½"}, {w:"å„é§…", k:"ã‹ããˆã", h:"ã™ã¹ã¦ã®é§…"}] },
        { char: "æ–™", on: "ãƒªãƒ§ã‚¦", kun: "-", words: [{w:"æ–™ç†", k:"ã‚Šã‚‡ã†ã‚Š", h:"é£Ÿäº‹ã‚’ä½œã‚‹ã“ã¨"}, {w:"æ–™é‡‘", k:"ã‚Šã‚‡ã†ãã‚“", h:"æ”¯æ‰•ã†ãŠé‡‘"}, {w:"ææ–™", k:"ã–ã„ã‚Šã‚‡ã†", h:"ä½œã‚‹ãŸã‚ã®åŸæ–™"}] },
        { char: "ä»²", on: "-", kun: "ãªã‹", words: [{w:"ä»²é–“", k:"ãªã‹ã¾", h:"ä¸€ç·’ã«ä½•ã‹ã™ã‚‹äºº"}, {w:"ä»²è‰¯ã—", k:"ãªã‹ã‚ˆã—", h:"é–¢ä¿‚ãŒè‰¯ã„ã“ã¨"}, {w:"ä»²ç›´ã‚Š", k:"ãªã‹ãªãŠã‚Š", h:"ã‘ã‚“ã‹ã®å¾Œã«å…ƒã«æˆ»ã‚‹"}] },
        { char: "åŠ´", on: "ãƒ­ã‚¦", kun: "-", words: [{w:"åŠ´åƒ", k:"ã‚ã†ã©ã†", h:"åƒã„ã¦è³ƒé‡‘ã‚’ã‚‚ã‚‰ã†"}, {w:"è‹¦åŠ´", k:"ãã‚ã†", h:"ç²¾ç¥çš„ãƒ»è‚‰ä½“çš„ã«å¤§å¤‰"}, {w:"ç–²åŠ´", k:"ã²ã‚ã†", h:"ã¨ã¦ã‚‚ç–²ã‚Œã‚‹ã“ã¨"}] },
        { char: "ç„¼", on: "ã‚·ãƒ§ã‚¦", kun: "ã‚„(ã)", words: [{w:"å¤•ç„¼ã‘", k:"ã‚†ã†ã‚„ã‘", h:"å¤•æ–¹ã®èµ¤ã„ç©º"}, {w:"ç„¼è‚‰", k:"ã‚„ãã«ã", h:"è‚‰ã‚’ç«ã«ã‹ã‘ã‚‹æ–™ç†"}, {w:"ç‡ƒç„¼", k:"ã­ã‚“ã—ã‚‡ã†", h:"ç‡ƒãˆã‚‹ã“ã¨"}] },
        { char: "å†·", on: "ãƒ¬ã‚¤", kun: "ã²(ã‚„ã™)", words: [{w:"å†·è”µåº«", k:"ã‚Œã„ãã†ã“", h:"é£Ÿå“ã‚’ä¿å­˜ã™ã‚‹å®¶é›»"}, {w:"å†·é™", k:"ã‚Œã„ã›ã„", h:"æ„Ÿæƒ…çš„ã«ãªã‚‰ãªã„"}, {w:"å†·ã‚„ã™", k:"ã²ã‚„ã™", h:"æ°·ãªã©ã§ï½"}] },
        { char: "ç…§", on: "ã‚·ãƒ§ã‚¦", kun: "ã¦(ã‚‰ã™)", words: [{w:"ç…§æ˜", k:"ã—ã‚‡ã†ã‚ã„", h:"éƒ¨å±‹ã®ãƒ©ã‚¤ãƒˆ"}, {w:"å¯¾ç…§", k:"ãŸã„ã—ã‚‡ã†", h:"äºŒã¤ã‚’æ¯”ã¹ã‚‹ã“ã¨"}, {w:"ç…§ã‚‰ã™", k:"ã¦ã‚‰ã™", h:"å…‰ã‚’å½“ã¦ã‚‹"}] }
    ];

    // --- State Management ---
    let kanjiData = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let wrongAnswers = [];
    
    // Canvas Vars
    const wrapper = document.getElementById('canvas-wrapper');
    const canvas = document.getElementById('drawing-board');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // --- Persistence Logic ---
    function loadData() {
        const stored = localStorage.getItem('myKanjiData');
        if (stored) {
            kanjiData = JSON.parse(stored);
        } else {
            kanjiData = JSON.parse(JSON.stringify(defaultData));
        }
        updateAdminList();
        document.getElementById("total-count").innerText = kanjiData.length;
        document.getElementById("db-count").innerText = kanjiData.length;
    }

    function saveData() {
        localStorage.setItem('myKanjiData', JSON.stringify(kanjiData));
        updateAdminList();
        document.getElementById("total-count").innerText = kanjiData.length;
        document.getElementById("db-count").innerText = kanjiData.length;
    }

    function resetDefaultData() {
        if(confirm("ç¢ºå®šè¦é‡ç½®å›é è¨­çš„ 56 å€‹æ¼¢å­—å—ï¼Ÿæ‚¨æ–°å¢çš„å­—æœƒæ¶ˆå¤±å–”ã€‚")) {
            localStorage.removeItem('myKanjiData');
            loadData();
        }
    }
    
    // --- Admin Dashboard Logic ---
    function toggleAdmin() {
        const quizView = document.getElementById('quiz-view');
        const adminView = document.getElementById('admin-view');
        
        if (quizView.style.display === "none") {
            quizView.style.display = "block";
            adminView.style.display = "none";
        } else {
            quizView.style.display = "none";
            adminView.style.display = "block";
            updateAdminList();
        }
    }

    function updateAdminList() {
        const list = document.getElementById('admin-list');
        list.innerHTML = "";
        // Show latest added first
        const revData = [...kanjiData].reverse();
        
        revData.forEach((item, index) => {
            const realIndex = kanjiData.length - 1 - index;
            const li = document.createElement("li");
            li.className = "kanji-item";
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="kanji-badge">${item.char}</span>
                    <div style="text-align:left;">
                        <span class="tag">éŸ³: ${item.on}</span>
                        <span class="tag">è¨“: ${item.kun}</span><br>
                        <small style="color:#666;">${item.words.map(w=>w.w).join(", ")}</small>
                    </div>
                </div>
                <button class="delete-btn" onclick="deleteKanji(${realIndex})">ğŸ—‘ï¸</button>
            `;
            list.appendChild(li);
        });
    }

    function deleteKanji(index) {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${kanjiData[index].char}ã€å—ï¼Ÿ`)) {
            kanjiData.splice(index, 1);
            saveData();
        }
    }

    // --- Manual Kanji Addition ---
    function addKanjiManual() {
        const char = document.getElementById('manual-char').value.trim();
        const on = document.getElementById('manual-on').value.trim() || "-";
        const kun = document.getElementById('manual-kun').value.trim() || "-";

        // Words
        const words = [];
        for(let i=1; i<=3; i++) {
            const w = document.getElementById(`w${i}-w`).value.trim();
            const k = document.getElementById(`w${i}-k`).value.trim();
            const h = document.getElementById(`w${i}-h`).value.trim();
            if(w && k) {
                words.push({w, k, h: h || "ãƒ’ãƒ³ãƒˆãªã—"});
            }
        }

        if (!char) { alert("è«‹è¼¸å…¥æ¼¢å­—ï¼"); return; }
        if (words.length === 0) { alert("è«‹è‡³å°‘è¼¸å…¥ä¸€çµ„ç†Ÿèªï¼"); return; }

        const newEntry = { char, on, kun, words };
        
        // Check duplicate
        const exists = kanjiData.find(k => k.char === char);
        if(exists) {
            if(confirm("é€™å€‹æ¼¢å­—å·²ç¶“å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ")) {
                 const idx = kanjiData.findIndex(k => k.char === char);
                 kanjiData[idx] = newEntry;
            } else {
                return;
            }
        } else {
            kanjiData.push(newEntry);
        }

        saveData();
        alert(`å·²å„²å­˜ã€Œ${char}ã€ï¼`);
        
        // Clear inputs
        document.getElementById('manual-char').value = "";
        document.getElementById('manual-on').value = "";
        document.getElementById('manual-kun').value = "";
        for(let i=1; i<=3; i++) {
            document.getElementById(`w${i}-w`).value = "";
            document.getElementById(`w${i}-k`).value = "";
            document.getElementById(`w${i}-h`).value = "";
        }
    }

    // --- Quiz Logic ---
    
    // Canvas resizing
    function resizeCanvas() {
        const rect = wrapper.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "#333";
    }
    window.addEventListener('load', () => { loadData(); resizeCanvas(); });
    window.addEventListener('resize', resizeCanvas);

    // Drawing
    function getTouchPos(canvasDom, touchEvent) {
        var rect = canvasDom.getBoundingClientRect();
        return {
            x: touchEvent.touches[0].clientX - rect.left,
            y: touchEvent.touches[0].clientY - rect.top
        };
    }
    canvas.addEventListener('mousedown', function(e) { isDrawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener('mousemove', function(e) { if (isDrawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
    canvas.addEventListener('mouseup', function() { isDrawing = false; });
    canvas.addEventListener('mouseout', function() { isDrawing = false; });
    canvas.addEventListener('touchstart', function(e) { e.preventDefault(); if (e.target == canvas) { isDrawing = true; var pos = getTouchPos(canvas, e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); } }, {passive: false});
    canvas.addEventListener('touchmove', function(e) { e.preventDefault(); if (isDrawing) { var pos = getTouchPos(canvas, e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } }, {passive: false});
    canvas.addEventListener('touchend', function(e) { isDrawing = false; });
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // Game Flow
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function startQuiz() {
        if(kanjiData.length === 0) { alert("é¡Œåº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåˆ°è¨­å®šæ–°å¢æ¼¢å­—ï¼"); return; }

        currentQuestions = kanjiData.map(item => {
            const randomWord = item.words[Math.floor(Math.random() * item.words.length)];
            return {
                id: item.char,
                q_word: randomWord.w,
                q_kana: randomWord.k,
                hint: randomWord.h,
                full_data: item
            };
        });
        currentQuestions = shuffle(currentQuestions);
        currentIndex = 0;
        wrongAnswers = [];

        document.getElementById("start-screen").classList.add("hidden");
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("quiz-interface").classList.remove("hidden");
        document.getElementById("total-q").innerText = currentQuestions.length;
        
        setTimeout(resizeCanvas, 100);
        loadQuestion();
    }

    function loadQuestion() {
        const q = currentQuestions[currentIndex];
        document.getElementById("current-num").innerText = currentIndex + 1;
        document.getElementById("q-kana").innerText = q.q_kana;
        document.getElementById("q-hint").innerText = "ãƒ’ãƒ³ãƒˆ: " + q.hint;
        
        clearCanvas();
        // Hide details
        document.getElementById("answer-details").style.display = "none";
        document.getElementById("draw-controls").classList.remove("hidden");
        document.getElementById("judge-controls").classList.add("hidden");
    }

    function speakQuestion() {
        const q = currentQuestions[currentIndex];
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(q.q_kana);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.85;
            window.speechSynthesis.speak(utterance);
        }
    }

    function showAnswer() {
        const q = currentQuestions[currentIndex];
        // Note: Overlay text removed as requested.
        // We simply show the details block below.

        document.getElementById("ans-word").innerText = q.q_word;
        document.getElementById("ans-info").innerText = `ç›®æ¨™æ¼¢å­—: ${q.id} (éŸ³: ${q.full_data.on} / è¨“: ${q.full_data.kun})`;
        document.getElementById("answer-details").style.display = "block";

        document.getElementById("draw-controls").classList.add("hidden");
        document.getElementById("judge-controls").classList.remove("hidden");
    }

    function recordResult(isCorrect) {
        if (!isCorrect) wrongAnswers.push(currentQuestions[currentIndex]);
        currentIndex++;
        if (currentIndex < currentQuestions.length) {
            loadQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        document.getElementById("quiz-interface").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
        
        const score = currentQuestions.length - wrongAnswers.length;
        document.getElementById("score-display").innerText = `${score} / ${currentQuestions.length} åˆ†`;
        
        const listContainer = document.getElementById("wrong-list");
        listContainer.innerHTML = "";
        
        if (wrongAnswers.length === 0) {
            listContainer.innerHTML = "<p style='color:green; font-weight:bold; font-size:1.2rem;'>å¤ªæ£’äº†ï¼å…¨å°ï¼ğŸ‰</p>";
        } else {
            wrongAnswers.forEach(item => {
                const div = document.createElement("div");
                div.style.borderBottom = "1px solid #eee";
                div.style.padding = "10px";
                div.style.display = "flex";
                div.style.justifyContent = "space-between";
                div.innerHTML = `
                    <div><span style="color:#666; font-size:0.8rem;">${item.q_kana}</span><br><strong>${item.q_word}</strong></div>
                    <div style="font-size:1.5rem; color:#e74c3c;">${item.id}</div>
                `;
                listContainer.appendChild(div);
            });
        }
    }
</script>

</body>
</html>

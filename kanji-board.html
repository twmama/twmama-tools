<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°åª½çš„æ¼¢å­—æ‰‹å¯«æ¿ (Pro v11.0)</title>
    <style>
        /* --- Base Styles --- */
        body { font-family: "Hiragino Kaku Gothic Pro", "Yu Gothic", sans-serif; background-color: #f0f4f8; text-align: center; padding: 10px; color: #333; overscroll-behavior: none; margin: 0; }
        .container { max-width: 650px; margin: 0 auto; background: white; min-height: 95vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); border-radius: 12px; overflow: hidden; }
        
        /* Header */
        header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        h1 { color: #007bff; margin: 0; font-size: 1.2rem; font-weight: bold; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* --- Quiz UI --- */
        #quiz-view { padding: 20px 10px; flex: 1; display: flex; flex-direction: column; }
        .progress-text { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        
        /* Start Screen Card */
        .welcome-card { background: #e8f4fd; padding: 25px; border-radius: 12px; margin: 20px auto; width: 90%; max-width: 400px; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Canvas Area */
        .canvas-container {
            position: relative; margin: 0 auto 15px auto; width: 100%; max-width: 600px; height: 220px;
            border: 3px solid #555; border-radius: 8px; background-color: #fff;
            touch-action: none; cursor: crosshair; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Grid Lines */
        .grid-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .grid-lines::before, .grid-lines::after { content: ""; position: absolute; top: 10px; bottom: 10px; width: 0; border-left: 2px dashed #ddd; }
        .grid-lines::before { left: 33.3%; } .grid-lines::after { left: 66.6%; }

        /* Question Display */
        .question-box { margin-bottom: 10px; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-text { font-size: 2.2rem; font-weight: bold; margin: 5px 0; letter-spacing: 2px; }
        .hint-text { font-size: 1rem; color: #d35400; background: #fff3e0; display: inline-block; padding: 3px 12px; border-radius: 15px; margin-top: 5px; }

        /* Answer Details */
        .answer-card { margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #eee; }
        .ans-word { font-size: 2.5rem; font-weight: bold; color:#e74c3c; font-family: serif; letter-spacing: 5px; }
        .srs-badge { font-size: 0.8rem; background: #eee; padding: 2px 8px; border-radius: 4px; color: #666; margin-top: 5px; display: inline-block;}

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
        .btn { font-size: 1rem; padding: 12px 24px; border: none; border-radius: 50px; cursor: pointer; color: white; min-width: 110px; box-shadow: 0 3px 0 rgba(0,0,0,0.1); font-weight: bold; transition: all 0.2s; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #2ecc71; }
        .btn-red { background-color: #e74c3c; }
        .btn-gray { background-color: #95a5a6; }
        .btn-yellow { background-color: #f1c40f; color: #333; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; min-width: auto; }

        /* Admin View */
        #admin-view { display: none; padding: 20px; text-align: left; background: #fff; flex: 1; overflow-y: auto; padding-bottom: 60px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: #f1f1f1; border: none; padding: 8px 12px; font-weight: bold; color: #666; cursor: pointer; border-radius: 6px; white-space: nowrap; }
        .tab-btn.active { background: #3498db; color: white; }

        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        /* Stats Table */
        table.stats-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        table.stats-table th, table.stats-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        table.stats-table th { background: #f9f9f9; color: #555; position: sticky; top: 0; }

        /* Manual Input specific */
        .manual-word-block { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* Footer Links & Watermark */
        .resource-links { margin-top: 30px; padding-top: 20px; border-top: 2px dashed #eee; text-align: center; }
        .link-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; color: #333; text-decoration: none; font-size: 0.95rem; transition: background 0.2s; box-sizing: border-box;}
        .link-btn:hover { background: #e2e6ea; }
        .watermark { margin-top: 30px; font-size: 0.8rem; color: #aaa; text-align: center; padding-bottom: 20px; }

        /* Utilities */
        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: white; }
        .bg-green { background: #27ae60; } .bg-orange { background: #e67e22; } .bg-red { background: #e74c3c; } .bg-blue { background: #3498db; }
        textarea.bulk-input { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 0.9rem; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 onclick="location.reload()" style="cursor:pointer;">ğŸ–ï¸ å°åª½çš„æ¼¢å­—æ‰‹å¯«æ¿</h1>
        <button class="settings-btn" onclick="toggleAdmin()">âš™ï¸</button>
    </header>

    <!-- === QUIZ VIEW (STUDENT) === -->
    <div id="quiz-view">
        <div id="start-screen">
            <div class="welcome-card">
                <h3 style="margin-top:0; color:#2c3e50;">æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ</h3>
                <p>1. è½èªéŸ³ï¼Œçœ‹æç¤ºã€‚</p>
                <p>2. åœ¨è™›ç·šæ ¼å­è£¡å¯«å‡ºæ­£ç¢ºçš„ç†Ÿèªã€‚</p>
                <p>3. å¯«å®ŒæŒ‰ã€Œçœ‹ç­”æ¡ˆã€ï¼Œè‡ªå·±æ”¹è€ƒå·ã€‚</p>
                <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
                <p style="font-size:0.9rem; color:#666;">
                    ç›®å‰é¡Œåº«ï¼š<strong id="total-count">0</strong> å­—<br>
                    ä»Šæ—¥å¾…è¤‡ç¿’ï¼š<strong id="start-due-count" style="color:#e74c3c;">0</strong> å­— (å«æ–°å­—)
                </p>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
                <button class="btn btn-blue" style="width: 80%;" onclick="startQuiz('due')">ğŸš€ é–‹å§‹ä»Šæ—¥ç·´ç¿’ (æ–°å­—å„ªå…ˆ)</button>
                <button class="btn btn-gray" style="width: 80%; background:#95a5a6;" onclick="startQuiz('all')">å…¨é¡Œåº«ç·´ç¿’ (ç„¡è…¦ç·´)</button>
            </div>
        </div>

        <div id="quiz-interface" class="hidden">
            <div class="progress-text">é€²åº¦ï¼š<span id="current-num">1</span> / <span id="total-q"></span> é¡Œ</div>
            
            <div class="question-box">
                <button class="btn btn-yellow btn-small" style="margin-bottom:5px;" onclick="speakQuestion()">ğŸ”Š æ’­æ”¾è²éŸ³</button>
                <div class="question-text" id="q-kana"></div>
                <div class="hint-text" id="q-hint"></div>
            </div>

            <div class="canvas-container" id="canvas-wrapper">
                <div class="grid-lines"></div>
                <canvas id="drawing-board"></canvas>
            </div>

            <div id="draw-controls" class="controls">
                <button class="btn btn-gray" onclick="clearCanvas()">é‡å¯«</button>
                <button class="btn btn-blue" onclick="showAnswer()">çœ‹ç­”æ¡ˆ</button>
            </div>

            <div id="judge-controls" class="controls hidden">
                <button class="btn btn-green" onclick="recordResult(5)">â­• å¯«å°äº†</button>
                <button class="btn btn-red" onclick="recordResult(0)">âŒ å¯«éŒ¯äº†</button>
            </div>
            
            <div id="answer-details" class="answer-card hidden">
                <div class="ans-word" id="ans-word"></div>
                <div style="color: #555; margin-top:5px;" id="ans-info"></div>
                <div class="srs-badge" id="srs-info"></div>
            </div>
        </div>

        <div id="result-screen" class="hidden">
            <h2 style="color:#2c3e50; margin-top:30px;">ç·´ç¿’çµæŸï¼</h2>
            <div style="font-size: 3.5rem; color:#3498db; margin: 15px 0; font-weight:bold;" id="score-display"></div>
            <p style="color:#666;">éŒ¯é¡Œå·²è‡ªå‹•æ’å…¥ã€Œæ˜æ—¥è¤‡ç¿’ã€æ¸…å–®ã€‚</p>
            <button class="btn btn-blue" style="margin-top: 20px;" onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>

        <div id="footer-area" style="margin-top:auto;">
             <div class="watermark">2025 å°åª½æ—¥çˆ¸æ¨‚å…±è®€ â”‚ twmamareads All Rights Reserved</div>
        </div>
    </div>

    <!-- === ADMIN VIEW (PARENT) === -->
    <div id="admin-view">
        <div class="admin-header">
            <h2 style="margin:0;">âš™ï¸ å®¶é•·ç®¡ç†å¾Œå°</h2>
            <button class="btn btn-gray btn-small" onclick="toggleAdmin()">é—œé–‰</button>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('tab-stats')">ğŸ“Š æ•¸æ“šä¸­å¿ƒ</button>
            <button class="tab-btn" onclick="switchTab('tab-manual')">âœï¸ æ‰‹å‹•æ–°å¢</button>
            <button class="tab-btn" onclick="switchTab('tab-import')">ğŸ“¥ æ‰¹é‡åŒ¯å…¥</button>
            <button class="tab-btn" onclick="switchTab('tab-settings')">âš™ï¸ è¨­å®šèˆ‡é€²åº¦</button>
        </div>

        <!-- TAB: Stats -->
        <div id="tab-stats" class="tab-content">
            <div style="background:#f9fff9; border:1px solid #d4edda; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:#155724;">å­¸ç¿’æ•¸æ“šåŒ¯å‡º</span>
                    <button class="btn btn-green btn-small" onclick="exportToCSV()">ğŸ“¥ ä¸‹è¼‰ CSV</button>
                </div>
                <p style="font-size:0.85rem; color:#666; margin:5px 0 0 0;">å¯å°‡æª”æ¡ˆä¸Ÿçµ¦ AI åˆ†æå­©å­å¼±é»ã€‚</p>
            </div>
            
            <h3 style="font-size:1rem; margin-bottom:10px;">å­¸ç¿’æ¦‚æ³ (ç¸½ç­†æ•¸: <span id="stats-total-count">0</span>)</h3>
            <table class="stats-table">
                <thead><tr><th>æ¼¢å­—</th><th>ç·´ç¿’</th><th>æ­£ç¢ºç‡</th><th>ç‹€æ…‹/ä¸‹æ¬¡</th></tr></thead>
                <tbody id="stats-list"></tbody>
            </table>
        </div>

        <!-- TAB: Manual Add -->
        <div id="tab-manual" class="tab-content hidden">
            <div class="form-group" style="background: #eef; padding: 15px; border-radius: 8px; border:1px solid #ddd;">
                <h3 style="margin-top:0; color:#007bff; font-size:1rem;">å–®å­—æ–°å¢</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:10px;">
                    <input type="text" id="manual-char" class="form-control" placeholder="æ¼¢å­— (ä¾‹:æ„›)">
                    <input type="text" id="manual-on" class="form-control" placeholder="éŸ³è®€">
                    <input type="text" id="manual-kun" class="form-control" placeholder="è¨“è®€">
                </div>
                <label style="margin-bottom:5px; display:block; font-size:0.9rem;">è¼¸å…¥ 1~3 çµ„ç†Ÿèªï¼š</label>
                <div id="word-inputs">
                    <div class="manual-word-block">
                        <input type="text" id="w1-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª1 (ä¾‹:æ„›æƒ…)">
                        <input type="text" id="w1-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³1 (ä¾‹:ã‚ã„ã˜ã‚‡ã†)">
                        <input type="text" id="w1-h" class="form-control" placeholder="æç¤º1">
                    </div>
                    <div class="manual-word-block">
                        <input type="text" id="w2-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª2">
                        <input type="text" id="w2-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³2">
                    </div>
                    <div class="manual-word-block">
                        <input type="text" id="w3-w" class="form-control" style="margin-bottom:5px;" placeholder="ç†Ÿèª3">
                        <input type="text" id="w3-k" class="form-control" style="margin-bottom:5px;" placeholder="è®€éŸ³3">
                    </div>
                </div>
                <button class="btn btn-green" style="width:100%;" onclick="addKanjiManual()">ç¢ºèªæ–°å¢</button>
            </div>
            
             <div style="margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>é¡Œåº«åˆ—è¡¨</h3>
                    <button class="btn btn-red btn-small" onclick="resetAllData()">âš ï¸ å…¨éƒ¨é‡ç½®</button>
                </div>
                <ul id="manage-list" style="list-style:none; padding:0;"></ul>
            </div>
        </div>

        <!-- TAB: File Import -->
        <div id="tab-import" class="tab-content hidden">
            <div style="border:1px solid #eee; padding:15px; border-radius:8px;">
                <p style="margin-top:0; font-size:0.9rem;">
                    1. é¸æ“‡åŒ…å« 202 å€‹å–®å­—çš„ CSV æª”æ¡ˆï¼š<br>
                    æ ¼å¼ï¼š<code>æ¼¢å­— | éŸ³è®€ | è¨“è®€ | ç†Ÿèª1 | è®€éŸ³1 | æç¤º1 ...</code>
                </p>
                <input type="file" id="file-input" accept=".csv" class="form-control" style="margin-bottom:10px;">
                
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <a href="https://docs.google.com/spreadsheets/d/1ZYU0fN19K71kXJWl29lJUZqs5sl6CPhIWCoKBC8YQW4/edit?usp=sharing" target="_blank" style="color:#007bff; text-decoration:none; font-size:0.9rem; display:flex; align-items:center;">ğŸ“‹ æŸ¥çœ‹ç¯„æœ¬è¡¨æ ¼</a>
                    <button class="btn btn-blue" onclick="processFileImport()">é–‹å§‹åŒ¯å…¥</button>
                </div>
            </div>
        </div>

        <!-- TAB: Settings -->
        <div id="tab-settings" class="tab-content hidden">
             <div class="welcome-card" style="background: #e8f4fd;">
                <h3 style="margin-top:0;">ğŸ“… ä»Šæ—¥å­¸ç¿’è¨ˆç•«</h3>
                <p>ç³»çµ±è¨ˆç®—ä»Šæ—¥æ‡‰è¤‡ç¿’ï¼š <strong id="admin-due-count" style="color:#e74c3c; font-size:1.4rem;">0</strong> å€‹å­—</p>
                <p style="font-size:0.9rem; color:#0056b3;">(åŒ…å«æœªç·´ç¿’éçš„æ–°å­— + åˆ°æœŸéœ€è¤‡ç¿’çš„èˆŠå­—)</p>
                <div style="display:flex; align-items:center; gap:10px; margin-top:15px;">
                    <label>æ¯æ—¥ç·´ç¿’ä¸Šé™ï¼š</label>
                    <input type="number" id="daily-limit" value="20" style="width:60px; padding:8px; border-radius:6px; border:1px solid #ccc; font-size:1rem; text-align:center;">
                    <button class="btn btn-blue btn-small" onclick="saveLimit()">å„²å­˜è¨­å®š</button>
                </div>
                <p style="font-size:0.85rem; color:#666;">* è¨­å®šç‚º 0 ä»£è¡¨ä¸é™åˆ¶ã€‚</p>
            </div>
        </div>

        <!-- Resource Links -->
        <div class="resource-links">
            <h4>ğŸ”— å°åª½è³‡æºé€£çµ</h4>
            <a href="https://twmama.notion.site/supportme?source=copy_link" target="_blank" class="link-btn">
                â˜• æ”¯æŒæˆ‘è£½ä½œæ›´å¤šå¤šèªè³‡æº
            </a>
            <a href="https://twmama.notion.site/resources-hub?source=copy_link" target="_blank" class="link-btn">
                ğŸ“š æ›´å¤šå…è²»è³‡æºï¼šå°åª½æ—¥çˆ¸æ¨‚å…±è®€
            </a>
            <div class="watermark">2025 å°åª½æ—¥çˆ¸æ¨‚å…±è®€ â”‚ twmamareads All Rights Reserved</div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'kanji_app_v11_db'; // New key
    let kanjiData = [];
    
    // Default Data: Sample only. Real data comes from Import.
    const defaultData = [
        { char: "ä»¤", on: "ãƒ¬ã‚¤", kun: "-", words: [{w:"å‘½ä»¤", k:"ã‚ã„ã‚Œã„", h:"ä¸Šã®äººãŒè¨€ã„ã¤ã‘ã‚‹"}, {w:"å·ä»¤", k:"ã”ã†ã‚Œã„", h:"å…¨ä½“ã«ã‹ã‘ã‚‹è¨€è‘‰"}, {w:"ä»¤å’Œ", k:"ã‚Œã„ã‚", h:"ä»Šã®å¹´å·"}] },
        { char: "ä½", on: "ã‚¤", kun: "ãã‚‰ã„", words: [{w:"ä¸€ä½", k:"ã„ã¡ã„", h:"ç«¶äº‰ã§ä¸€ç•ªã«ãªã‚‹"}, {w:"åœ°ä½", k:"ã¡ã„", h:"ç¤¾ä¼šçš„ãªç«‹å ´"}] }
    ];

    function createSRSNode() {
        return {
            interval: 0,      
            repetition: 0,    
            ef: 2.5,          
            dueDate: Date.now(), 
            stats: { total: 0, correct: 0 }
        };
    }

    function calculateSM2(item, quality) {
        let srs = item.srs || createSRSNode();
        srs.stats.total++;
        if (quality >= 3) srs.stats.correct++;

        if (quality >= 3) {
            if (srs.repetition === 0) srs.interval = 1;
            else if (srs.repetition === 1) srs.interval = 3;
            else srs.interval = Math.round(srs.interval * srs.ef);
            srs.repetition++;
            srs.ef = srs.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (srs.ef < 1.3) srs.ef = 1.3;
        } else {
            srs.repetition = 0;
            srs.interval = 1; 
        }

        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + srs.interval);
        srs.dueDate = nextDate.getTime();
        return srs;
    }

    // --- Persistence ---
    function loadData() {
        const stored = localStorage.getItem(DB_KEY);
        if (stored) {
            kanjiData = JSON.parse(stored);
            kanjiData.forEach(k => {
                if(!k.srs) k.srs = createSRSNode();
                if(!k.srs.stats) k.srs.stats = { total: 0, correct: 0 };
            });
        } else {
            kanjiData = JSON.parse(JSON.stringify(defaultData));
            kanjiData.forEach(k => k.srs = createSRSNode());
            saveData();
        }
        updateDashboard();
    }

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(kanjiData));
        updateDashboard();
    }
    
    function saveLimit() {
        const limit = document.getElementById('daily-limit').value;
        localStorage.setItem('daily_limit', limit);
        alert("è¨­å®šå·²å„²å­˜ï¼ä»Šæ—¥å­¸ç¿’è¨ˆç•«å·²æ›´æ–°ã€‚");
        updateDashboard();
    }

    function resetAllData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡ç½®å—ï¼Ÿç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }

    // --- Dashboard & Quiz Logic ---
    let quizQueue = [];
    let currentQIndex = 0;
    let quizResults = { correct: 0, total: 0 };

    function updateDashboard() {
        const now = Date.now();
        // Count New Items (repetition == 0)
        const newItemsCount = kanjiData.filter(k => k.srs.repetition === 0).length;
        // Count Due Items (repetition > 0 AND dueDate <= now)
        const dueItemsCount = kanjiData.filter(k => k.srs.repetition > 0 && k.srs.dueDate <= now).length;
        
        const totalDue = newItemsCount + dueItemsCount;
        
        document.getElementById('total-count').innerText = kanjiData.length;
        document.getElementById('start-due-count').innerText = totalDue;
        document.getElementById('admin-due-count').innerText = totalDue;
        
        const savedLimit = localStorage.getItem('daily_limit');
        if(savedLimit) document.getElementById('daily-limit').value = savedLimit;
    }

    function startQuiz(mode) {
        let queue = [];
        const now = Date.now();
        const limit = parseInt(document.getElementById('daily-limit').value) || 9999;

        if (mode === 'due') {
            // NEW LOGIC: New Kanji (Rep=0) First, then Due Kanji
            const newItems = kanjiData.filter(k => k.srs.repetition === 0);
            const dueItems = kanjiData.filter(k => k.srs.repetition > 0 && k.srs.dueDate <= now);
            
            // Sort due items by urgency
            dueItems.sort((a,b) => a.srs.interval - b.srs.interval);
            
            // Combine: New items first!
            queue = [...newItems, ...dueItems];
        } else {
            queue = [...kanjiData];
            queue.sort(() => Math.random() - 0.5);
        }

        if (queue.length === 0 && mode === 'due') {
            alert("å¤ªæ£’äº†ï¼ä»Šå¤©æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å­—ã€‚");
            return;
        }

        if (queue.length > limit) {
            queue = queue.slice(0, limit);
        }

        quizQueue = queue.map(item => {
            const word = item.words[Math.floor(Math.random() * item.words.length)];
            return {
                id: item.char,
                q_word: word.w,
                q_kana: word.k,
                hint: word.h,
                full_item: item
            };
        });

        currentQIndex = 0;
        quizResults = { correct: 0, total: quizQueue.length };
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('footer-area').classList.add('hidden');
        document.getElementById('quiz-interface').classList.remove('hidden');
        document.getElementById('total-q').innerText = quizQueue.length;
        
        loadQuestion();
    }

    function loadQuestion() {
        const q = quizQueue[currentQIndex];
        document.getElementById('current-num').innerText = currentQIndex + 1;
        document.getElementById('q-kana').innerText = q.q_kana;
        document.getElementById('q-hint').innerText = "ãƒ’ãƒ³ãƒˆ: " + q.hint;
        
        clearCanvas();
        document.getElementById('draw-controls').classList.remove('hidden');
        document.getElementById('judge-controls').classList.add('hidden');
        document.getElementById('answer-details').classList.add('hidden');
        
        resizeCanvas();
    }

    function showAnswer() {
        const q = quizQueue[currentQIndex];
        const item = q.full_item;
        
        document.getElementById('ans-word').innerText = q.q_word;
        document.getElementById('ans-info').innerText = `ç›®æ¨™: ${item.char} (éŸ³: ${item.on} / è¨“: ${item.kun})`;
        
        const daysCorrect = calculateSM2(JSON.parse(JSON.stringify(item)), 5).interval;
        document.getElementById('srs-info').innerText = `é æ¸¬è¤‡ç¿’: ç­”å°(${daysCorrect}å¤©å¾Œ) / ç­”éŒ¯(æ˜å¤©)`;

        document.getElementById('answer-details').classList.remove('hidden');
        document.getElementById('draw-controls').classList.add('hidden');
        document.getElementById('judge-controls').classList.remove('hidden');
    }

    function recordResult(quality) {
        const q = quizQueue[currentQIndex];
        const realItem = kanjiData.find(k => k.char === q.id);
        
        if (realItem) {
            realItem.srs = calculateSM2(realItem, quality);
            saveData();
        }

        if (quality >= 3) quizResults.correct++;

        currentQIndex++;
        if (currentQIndex < quizQueue.length) {
            loadQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        document.getElementById('quiz-interface').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        const percentage = Math.round((quizResults.correct / quizResults.total) * 100);
        document.getElementById('score-display').innerText = percentage + "%";
    }

    // --- Admin & Stats ---
    function toggleAdmin() {
        const quizView = document.getElementById('quiz-view');
        const adminView = document.getElementById('admin-view');
        if (quizView.style.display === "none") {
            quizView.style.display = "flex";
            adminView.style.display = "none";
        } else {
            quizView.style.display = "none";
            adminView.style.display = "block";
            // Refresh views
            updateDashboard();
            renderStats();
            renderManageList();
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tabId === 'tab-stats') renderStats();
        if(tabId === 'tab-manual') renderManageList();
    }

    function renderStats() {
        const tbody = document.getElementById('stats-list');
        tbody.innerHTML = "";
        document.getElementById('stats-total-count').innerText = kanjiData.length;
        
        // Sort: Accuracy (low to high), then New items last
        const sorted = [...kanjiData].sort((a,b) => {
            const accA = a.srs.stats.total ? (a.srs.stats.correct/a.srs.stats.total) : 1;
            const accB = b.srs.stats.total ? (b.srs.stats.correct/b.srs.stats.total) : 1;
            return accA - accB;
        });

        sorted.forEach(k => {
            const rate = k.srs.stats.total ? Math.round((k.srs.stats.correct / k.srs.stats.total)*100) : 0;
            const isNew = k.srs.repetition === 0;
            const nextDate = isNew ? "æ–°å­—(å¾…ç·´ç¿’)" : new Date(k.srs.dueDate).toLocaleDateString();
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${k.char}</strong></td>
                <td>${k.srs.stats.total}</td>
                <td><span class="badge ${isNew ? 'bg-blue' : (rate < 60 ? 'bg-red' : (rate < 90 ? 'bg-orange' : 'bg-green'))}">${isNew ? 'New' : rate+'%'}</span></td>
                <td>${nextDate}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function exportToCSV() {
        let csvContent = "\uFEFF"; 
        csvContent += "æ¼¢å­—,éŸ³è®€,è¨“è®€,ç·´ç¿’æ¬¡æ•¸,æ­£ç¢ºç‡(%),ä¸‹æ¬¡è¤‡ç¿’æ—¥,é–“éš”(å¤©),ç†Ÿèªç¯„ä¾‹\n";
        
        kanjiData.forEach(k => {
            const rate = k.srs.stats.total ? ((k.srs.stats.correct / k.srs.stats.total)*100).toFixed(1) : 0;
            const next = new Date(k.srs.dueDate).toISOString().split('T')[0];
            const words = k.words.map(w => w.w).join(";");
            csvContent += `${k.char},${k.on},${k.kun},${k.srs.stats.total},${rate},${next},${k.srs.interval},"${words}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `æ¼¢å­—å­¸ç¿’æ•¸æ“š_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }
    
    // --- Manual Add Logic ---
    function addKanjiManual() {
        const char = document.getElementById('manual-char').value.trim();
        const on = document.getElementById('manual-on').value.trim() || "-";
        const kun = document.getElementById('manual-kun').value.trim() || "-";

        const words = [];
        for(let i=1; i<=3; i++) {
            const w = document.getElementById(`w${i}-w`).value.trim();
            const k = document.getElementById(`w${i}-k`).value.trim();
            const h = document.getElementById(`w${i}-h`).value.trim();
            if(w && k) words.push({w, k, h: h || "ãƒ’ãƒ³ãƒˆãªã—"});
        }

        if (!char) { alert("è«‹è¼¸å…¥æ¼¢å­—ï¼"); return; }
        if (words.length === 0) { alert("è«‹è‡³å°‘è¼¸å…¥ä¸€çµ„ç†Ÿèªï¼"); return; }

        const newEntry = { char, on, kun, words, srs: createSRSNode() };
        
        const idx = kanjiData.findIndex(k => k.char === char);
        if(idx >= 0) {
            if(confirm("é€™å€‹æ¼¢å­—å·²ç¶“å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ")) kanjiData[idx] = newEntry;
            else return;
        } else {
            kanjiData.push(newEntry);
        }

        saveData();
        alert(`å·²å„²å­˜ã€Œ${char}ã€ï¼`);
        // Clear Form
        document.getElementById('manual-char').value = "";
        document.getElementById('manual-on').value = "";
        document.getElementById('manual-kun').value = "";
        for(let i=1; i<=3; i++) {
            document.getElementById(`w${i}-w`).value = "";
            document.getElementById(`w${i}-k`).value = "";
            document.getElementById(`w${i}-h`).value = "";
        }
        renderManageList();
    }
    
    function renderManageList() {
        const ul = document.getElementById('manage-list');
        ul.innerHTML = "";
        // Show newest first
        [...kanjiData].reverse().forEach((k) => {
             // Find original index
            const originalIdx = kanjiData.findIndex(item => item.char === k.char);
            const li = document.createElement('li');
            li.innerHTML = `
                <div style="background:#f9f9f9; padding:8px 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;"><strong>${k.char}</strong> <span style="color:#666; font-size:0.8rem;">(${k.words.length}è©)</span></span>
                    <button class="btn btn-red btn-small" onclick="deleteItem(${originalIdx})">ğŸ—‘ï¸</button>
                </div>`;
            ul.appendChild(li);
        });
    }
    function deleteItem(idx) {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            kanjiData.splice(idx, 1);
            saveData();
            renderManageList();
        }
    }

    // --- File Import Logic (UPDATED) ---
    function processFileImport() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) {
            return alert("è«‹é¸æ“‡ä¸€å€‹ .csv æª”æ¡ˆï¼");
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const raw = e.target.result;
            const lines = raw.split(/\r\n|\n/);
            let addedCount = 0;

            lines.forEach(line => {
                // Regex to split by comma but ignore commas inside quotes
                const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
                
                // Clean quotes
                const cleanParts = parts.map(p => p ? p.trim().replace(/^"|"$/g, '') : '');
                
                if (cleanParts.length < 6) return;
                if (cleanParts[0] === "æ¼¢å­—") return; // Skip header

                const char = cleanParts[0];
                const on = cleanParts[1] || "-";
                const kun = cleanParts[2] || "-";
                
                let words = [];
                for (let i = 3; i < cleanParts.length; i += 3) {
                    if (cleanParts[i] && cleanParts[i+1]) {
                        words.push({ 
                            w: cleanParts[i], 
                            k: cleanParts[i+1], 
                            h: cleanParts[i+2] || "ãƒ’ãƒ³ãƒˆãªã—" 
                        });
                    }
                }

                if (char && words.length > 0) {
                    const idx = kanjiData.findIndex(k => k.char === char);
                    const newItem = { char, on, kun, words, srs: createSRSNode() };
                    if (idx >= 0) {
                        kanjiData[idx].words = words;
                        kanjiData[idx].on = on;
                        kanjiData[idx].kun = kun;
                    } else {
                        kanjiData.push(newItem);
                        addedCount++;
                    }
                }
            });

            saveData(); // Save to local storage
            
            // Refresh the UI lists immediately
            renderManageList();
            renderStats();
            
            alert(`åŒ¯å…¥æˆåŠŸï¼å…±æ–°å¢/æ›´æ–°äº† ${addedCount} å€‹æ¼¢å­—ã€‚\nè«‹åˆ‡æ›åˆ°ã€Œæ•¸æ“šä¸­å¿ƒã€æŸ¥çœ‹å®Œæ•´åˆ—è¡¨ã€‚`);
            fileInput.value = "";
        };
        
        reader.readAsText(file);
    }
    
    // --- Canvas ---
    const canvas = document.getElementById('drawing-board');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    
    function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width; canvas.height = rect.height;
        ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.strokeStyle = "#333";
    }
    window.addEventListener('load', () => { loadData(); resizeCanvas(); });
    window.addEventListener('resize', resizeCanvas);
    
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    ['mousedown','touchstart'].forEach(ev=>canvas.addEventListener(ev, e=>{ isDrawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); if(ev=='touchstart')e.preventDefault(); }));
    ['mousemove','touchmove'].forEach(ev=>canvas.addEventListener(ev, e=>{ if(!isDrawing)return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); if(ev=='touchmove')e.preventDefault(); }));
    ['mouseup','mouseout','touchend'].forEach(ev=>canvas.addEventListener(ev, ()=>{ isDrawing=false; }));
    
    function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }
    function speakQuestion() {
        const txt = document.getElementById('q-kana').innerText;
        if('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang='ja-JP'; u.rate=0.85;
            speechSynthesis.speak(u);
        }
    }
</script>

</body>
</html>
